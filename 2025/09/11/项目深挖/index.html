<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="-jCet6qPD7nML4-W6IY2HZwfSblJyWta_Jx7_AGHgIk">
  <meta name="baidu-site-verification" content="f349dc627a72ee616d62ed513574025d">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/orange/pace-theme-center-circle.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"weirdozz.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="项目内容mca系统记录部门里会出现的各种风险和控制措施，control inventory的用户他们确定用哪个控制措施去降低特定风险， gau和sau(具体部门的人）会采用这套控制措施并执行 基本数据结构Manager’s Control Assessment (MCA) 是花旗内部的风控管理系统，用于对公司关键流程（GPMP：Global Process and Management Proce">
<meta property="og:type" content="article">
<meta property="og:title" content="项目深挖">
<meta property="og:url" content="https://weirdozz.github.io/2025/09/11/%E9%A1%B9%E7%9B%AE%E6%B7%B1%E6%8C%96/index.html">
<meta property="og:site_name" content="Weirdo">
<meta property="og:description" content="项目内容mca系统记录部门里会出现的各种风险和控制措施，control inventory的用户他们确定用哪个控制措施去降低特定风险， gau和sau(具体部门的人）会采用这套控制措施并执行 基本数据结构Manager’s Control Assessment (MCA) 是花旗内部的风控管理系统，用于对公司关键流程（GPMP：Global Process and Management Proce">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.imgur.com/n44WE3Y.png">
<meta property="og:image" content="https://i.imgur.com/zSNzkh4.png">
<meta property="article:published_time" content="2025-09-11T11:44:24.000Z">
<meta property="article:modified_time" content="2025-09-25T13:48:12.818Z">
<meta property="article:author" content="Weirdo">
<meta property="article:tag" content="WeirdoBlog">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/n44WE3Y.png">


<link rel="canonical" href="https://weirdozz.github.io/2025/09/11/%E9%A1%B9%E7%9B%AE%E6%B7%B1%E6%8C%96/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://weirdozz.github.io/2025/09/11/%E9%A1%B9%E7%9B%AE%E6%B7%B1%E6%8C%96/","path":"2025/09/11/项目深挖/","title":"项目深挖"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>项目深挖 | Weirdo</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Weirdo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-movies"><a href="/movies/" rel="section"><i class="fa fa-film fa-fw"></i>电影</a></li>
        <li class="menu-item menu-item-books"><a href="/books/" rel="section"><i class="fa fa-book fa-fw"></i>书籍</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E5%86%85%E5%AE%B9"><span class="nav-number">1.</span> <span class="nav-text">项目内容</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.</span> <span class="nav-text">基本数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%8E%A7%E5%88%B6%E7%82%B9"><span class="nav-number">1.1.1.</span> <span class="nav-text">常见控制点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Monitoring-%E6%80%8E%E4%B9%88%E8%B7%91"><span class="nav-number">1.1.2.</span> <span class="nav-text">Monitoring 怎么跑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96%E6%96%B9%E5%BC%8F"><span class="nav-number">1.1.3.</span> <span class="nav-text">数据获取方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%9A%E5%8A%A1%E5%AE%8C%E6%95%B4%E9%80%BB%E8%BE%91"><span class="nav-number">1.2.</span> <span class="nav-text">业务完整逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL1000"><span class="nav-number">1.3.</span> <span class="nav-text">SQL1000</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E5%86%99%E7%9A%84%E6%97%B6%E5%80%99%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.3.1.</span> <span class="nav-text">实际写的时候遇到的问题</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transactional"><span class="nav-number">1.4.</span> <span class="nav-text">@Transactional</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA"><span class="nav-number">1.4.1.</span> <span class="nav-text">传播行为</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-number">1.4.2.</span> <span class="nav-text">事务隔离级别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E5%8F%82%E6%95%B0"><span class="nav-number">1.4.3.</span> <span class="nav-text">其他参数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AOP"><span class="nav-number">1.5.</span> <span class="nav-text">AOP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86%EF%BC%9A"><span class="nav-number">1.5.1.</span> <span class="nav-text">组成部分：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SpringAOP"><span class="nav-number">1.5.2.</span> <span class="nav-text">SpringAOP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PointCut-%E8%AF%AD%E6%B3%95"><span class="nav-number">1.5.3.</span> <span class="nav-text">PointCut 语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%BC%8F%E4%BD%BF%E7%94%A8AOP"><span class="nav-number">1.5.4.</span> <span class="nav-text">编程式使用AOP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AOP%E6%9C%AC%E8%B4%A8%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.5.5.</span> <span class="nav-text">AOP本质实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AspectJ"><span class="nav-number">1.5.6.</span> <span class="nav-text">AspectJ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CompletableFuture"><span class="nav-number">1.6.</span> <span class="nav-text">CompletableFuture</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.6.1.</span> <span class="nav-text">执行流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ForkJoinPool"><span class="nav-number">1.6.2.</span> <span class="nav-text">ForkJoinPool</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HttpExchange"><span class="nav-number">1.7.</span> <span class="nav-text">HttpExchange</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#HttpExchange%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="nav-number">1.7.1.</span> <span class="nav-text">HttpExchange的实现方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HttpExchange%E6%98%AF%E9%98%BB%E5%A1%9E%E7%9A%84%E8%BF%98%E6%98%AF%E5%BC%82%E6%AD%A5%E7%9A%84"><span class="nav-number">1.7.2.</span> <span class="nav-text">@HttpExchange是阻塞的还是异步的</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Mono-x2F-Flux-reactive-call"><span class="nav-number">1.7.3.</span> <span class="nav-text">Mono&#x2F;Flux reactive call</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E5%B8%83-x2F-%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="nav-number">1.7.4.</span> <span class="nav-text">发布&#x2F;订阅模式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kafka"><span class="nav-number">1.8.</span> <span class="nav-text">Kafka</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84"><span class="nav-number">1.8.1.</span> <span class="nav-text">消费者组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kafka%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%BF%A1%E6%81%AF%E4%B8%8D%E4%B8%A2%E5%A4%B1"><span class="nav-number">1.8.2.</span> <span class="nav-text">Kafka如何保证信息不丢失</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kafka%E7%9A%84Offset%E6%98%AF%E6%80%8E%E4%B9%88%E7%AE%A1%E7%90%86%E7%9A%84"><span class="nav-number">1.8.3.</span> <span class="nav-text">Kafka的Offset是怎么管理的</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84-rebalance-%E6%98%AF%E6%80%8E%E4%B9%88%E5%8F%91%E7%94%9F%E7%9A%84%EF%BC%9F"><span class="nav-number">1.8.4.</span> <span class="nav-text">消费者组 rebalance 是怎么发生的？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E5%92%8Ckafka%E4%BA%8B%E5%8A%A1%E5%90%88%E5%B9%B6"><span class="nav-number">1.8.5.</span> <span class="nav-text">数据库事务和kafka事务合并</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kafka-%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96%E7%82%B9%EF%BC%9F"><span class="nav-number">1.8.6.</span> <span class="nav-text">Kafka 生产者和消费者常用配置优化点？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kraft-x2F-raft"><span class="nav-number">1.8.7.</span> <span class="nav-text">Kraft&#x2F;raft</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Raft"><span class="nav-number">1.8.7.1.</span> <span class="nav-text">Raft</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%AF%E6%9C%AC%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6"><span class="nav-number">1.8.8.</span> <span class="nav-text">副本同步机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AppDynamic"><span class="nav-number">1.8.9.</span> <span class="nav-text">AppDynamic</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Seata"><span class="nav-number">1.9.</span> <span class="nav-text">Seata</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#XA%E5%8D%8F%E8%AE%AE%E7%9A%842PC%E5%92%8C3PC%EF%BC%88%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%89"><span class="nav-number">1.9.1.</span> <span class="nav-text">XA协议的2PC和3PC（强一致性）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AT%E6%A8%A1%E5%BC%8F%EF%BC%88%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%89"><span class="nav-number">1.9.2.</span> <span class="nav-text">AT模式（最终一致性）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Saga%E6%A8%A1%E5%BC%8F"><span class="nav-number">1.9.3.</span> <span class="nav-text">Saga模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Seata-%E7%9A%84%E4%BA%8B%E5%8A%A1%E8%A7%92%E8%89%B2%E6%9C%89%E5%93%AA%E4%BA%9B%EF%BC%9F"><span class="nav-number">1.9.4.</span> <span class="nav-text">Seata 的事务角色有哪些？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Seata-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%B9%82%E7%AD%89%E6%80%A7%E5%92%8C%E9%98%B2%E6%82%AC%E6%8C%82%EF%BC%9F"><span class="nav-number">1.9.5.</span> <span class="nav-text">Seata 如何保证幂等性和防悬挂？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Seata-Undo-Log-%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E8%86%A8%E8%83%80%EF%BC%9F"><span class="nav-number">1.9.6.</span> <span class="nav-text">Seata Undo Log 如何避免膨胀？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#vgroup-mapping-%E5%92%8C-tx-service-group"><span class="nav-number">1.9.7.</span> <span class="nav-text">vgroup-mapping 和 tx-service-group</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">1.10.</span> <span class="nav-text">数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89%E5%A4%A7%E6%97%A5%E5%BF%97"><span class="nav-number">1.10.1.</span> <span class="nav-text">三大日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="nav-number">1.10.2.</span> <span class="nav-text">分库分表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1ID%EF%BC%88%E5%88%86%E7%89%87%E9%94%AE%EF%BC%89"><span class="nav-number">1.10.3.</span> <span class="nav-text">路由ID（分片键）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ShardingSphere"><span class="nav-number">1.10.3.1.</span> <span class="nav-text">ShardingSphere</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1-x2F-%E5%AE%9A%E9%97%B4%E9%9A%94%E4%BB%BB%E5%8A%A1"><span class="nav-number">1.11.</span> <span class="nav-text">定时任务&#x2F;定间隔任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JBPM"><span class="nav-number">1.12.</span> <span class="nav-text">JBPM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AI%E5%BA%94%E7%94%A8"><span class="nav-number">1.13.</span> <span class="nav-text">AI应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%A7%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.14.</span> <span class="nav-text">大模型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83"><span class="nav-number">1.14.1.</span> <span class="nav-text">大模型微调</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Langchain4j-%E6%9E%84%E5%BB%BA-Agent"><span class="nav-number">1.15.</span> <span class="nav-text">Langchain4j 构建 Agent</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Sequence-%E5%B7%A5%E4%BD%9C%E6%B5%81"><span class="nav-number">1.15.1.</span> <span class="nav-text">Sequence 工作流</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Loop-%E5%B7%A5%E4%BD%9C%E6%B5%81"><span class="nav-number">1.15.2.</span> <span class="nav-text">Loop 工作流</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Parallel-%E5%B7%A5%E4%BD%9C%E6%B5%81"><span class="nav-number">1.15.3.</span> <span class="nav-text">Parallel 工作流</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E5%B7%A5%E4%BD%9C%E6%B5%81"><span class="nav-number">1.15.4.</span> <span class="nav-text">条件工作流</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E4%B8%8A%E7%BA%BF%E5%90%8E%E8%BF%98%E6%9C%89%E5%81%9ARAG%E7%9A%84%E8%AF%84%E4%BC%B0%E5%90%97%EF%BC%9F"><span class="nav-number">1.15.5.</span> <span class="nav-text">项目上线后还有做RAG的评估吗？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MCP%E5%86%85%E5%AE%B9%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.15.6.</span> <span class="nav-text">MCP内容是什么</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Java%E9%94%81%E6%9C%BA%E5%88%B6"><span class="nav-number">1.16.</span> <span class="nav-text">Java锁机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%92%E4%BB%96%E9%94%81"><span class="nav-number">1.16.1.</span> <span class="nav-text">排他锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B1%E4%BA%AB%E9%94%81"><span class="nav-number">1.16.2.</span> <span class="nav-text">共享锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B9%90%E8%A7%82%E9%94%81"><span class="nav-number">1.16.3.</span> <span class="nav-text">乐观锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AQS-AbstractQueuedSynchronizer"><span class="nav-number">1.16.4.</span> <span class="nav-text">AQS( AbstractQueuedSynchronizer)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JVM%E9%94%81%E7%9A%84%E5%8E%9F%E7%90%86-%E5%BD%93JVM%E9%94%81%E9%87%8A%E6%94%BE%E4%BA%86%EF%BC%8C%E5%85%B6%E4%BD%99%E7%BA%BF%E7%A8%8B%E5%A6%82%E4%BD%95%E7%9F%A5%E9%81%93%EF%BC%8C%E5%A6%82%E4%BD%95%E7%AB%9E%E4%BA%89"><span class="nav-number">1.16.5.</span> <span class="nav-text">JVM锁的原理,当JVM锁释放了，其余线程如何知道，如何竞争</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Weirdo"
      src="/images/weirdo.jpg">
  <p class="site-author-name" itemprop="name">Weirdo</p>
  <div class="site-description" itemprop="description">怕什么真理无穷，进一步有进一步的欢喜</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://weirdozz.github.io/2025/09/11/%E9%A1%B9%E7%9B%AE%E6%B7%B1%E6%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/weirdo.jpg">
      <meta itemprop="name" content="Weirdo">
      <meta itemprop="description" content="怕什么真理无穷，进一步有进一步的欢喜">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Weirdo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          项目深挖
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-09-11 19:44:24" itemprop="dateCreated datePublished" datetime="2025-09-11T19:44:24+08:00">2025-09-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-25 21:48:12" itemprop="dateModified" datetime="2025-09-25T21:48:12+08:00">2025-09-25</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2025/09/11/%E9%A1%B9%E7%9B%AE%E6%B7%B1%E6%8C%96/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2025/09/11/项目深挖/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="项目内容"><a href="#项目内容" class="headerlink" title="项目内容"></a>项目内容</h2><p>mca系统记录部门里会出现的各种风险和控制措施，control inventory的用户他们确定用哪个控制措施去降低特定风险， gau和sau(具体部门的人）会采用这套控制措施并执行</p>
<h3 id="基本数据结构"><a href="#基本数据结构" class="headerlink" title="基本数据结构"></a>基本数据结构</h3><p>Manager’s Control Assessment (MCA) 是花旗内部的风控管理系统，用于对公司关键流程（GPMP：Global Process and Management Procedure）进行 控制设计、监控执行和独立测试，确保流程风险可控、符合监管要求（类似 SOX 合规和风险框架）。</p>
<p>每个 Control 对应一个 GPMP 流程，用于描述风险点和控制措施。<br>常见字段有：</p>
<ul>
<li>Id（主键）</li>
<li>GPMPId（关联的流程 ID）</li>
<li>Title（控制点标题）</li>
<li>Description（控制点描述）</li>
<li>Control Owner（责任人）</li>
<li>Approver（审批人）</li>
<li>Frequency（执行频率，比如 daily&#x2F;weekly&#x2F;monthly）</li>
<li>Key Risk Indicator (KRI)：关键指标是什么，比如说用户选择了 异常交易率，审批延误率这两种指标</li>
<li>Expected Outcome &#x2F; Control Target：指标的期望值，期望值为多少属于正常</li>
<li>Sample Size：比如：抽样 100 笔付款检查合规性。</li>
<li>Control Category &#x2F; Type（手工 &#x2F; 自动、预防 &#x2F; 检测）</li>
<li>L1 &#x2F; L2 &#x2F; L3 Mapping（不同层级的流程或风险分类，比如 L1&#x3D;业务大类，L2&#x3D;子类，L3&#x3D;具体流程）</li>
<li>Status（Draft, Pending Approve, Approved, Retired）</li>
</ul>
<p>Monitoring 是对 Control 的执行效果进行 量化跟踪，由系统或用户设定参数，系统自动比对并生成结果。<br>可能字段：</p>
<ul>
<li>MonitoringId</li>
<li>ControlId（对应的 Control）</li>
<li>Metric &#x2F; KPI（监控指标，比如失败率、异常数）</li>
<li>Threshold（阈值，比如异常率不能超过 2%）</li>
<li>Time Window（监控周期：daily&#x2F;weekly&#x2F;monthly）</li>
<li>Alert Rule（超过阈值时触发告警）</li>
<li>Escalation Level（告警升级路径）</li>
<li>Status（Active, Suspended）</li>
</ul>
<p>Testing 是由 第三方或独立团队定期对 Control 的有效性做抽查。<br>字段可能有：</p>
<ul>
<li>TestingId</li>
<li>ControlId</li>
<li>Test Plan（测试计划：抽样多少、方法）</li>
<li>Frequency（季度 &#x2F; 半年 &#x2F; 一年）</li>
<li>Tester（责任人，独立于 Control Owner）</li>
<li>Test Result（Pass &#x2F; Fail &#x2F; Partial）</li>
<li>Evidence（附件或证明）</li>
<li>Report（最终报告生成）</li>
<li>Testing 和 Monitoring 的区别：</li>
<li>Monitoring &#x3D; 自动化、持续监控</li>
<li>Testing &#x3D; 抽样验证，更偏人工&#x2F;审计手段</li>
</ul>
<p>创建一个 Control 的流程：</p>
<ul>
<li>用户创建 Control，绑定 GPMP 流程，填好字段。</li>
<li>Control 状态变为 Pending Approve。</li>
<li>系统自动生成两个待办任务：</li>
<li>Monitoring Pending Creation</li>
<li>Testing Pending Creation</li>
<li>任务进入 jBPM 流程，相关责任人配置参数</li>
<li>审批通过后，Control 生效，并进入周期性运行（Monitoring 定时检测，Testing 定期执行）。</li>
</ul>
<span id="more"></span>

<h4 id="常见控制点"><a href="#常见控制点" class="headerlink" title="常见控制点"></a>常见控制点</h4><p>A. IT 类控制点</p>
<ul>
<li>Control：关键系统用户权限必须每季度复核</li>
<li>Monitoring：监控“复核完成情况”</li>
<li>监控什么：所有系统是否提交了权限复核报告（Yes&#x2F;No），完成率（已提交 ÷ 应提交）</li>
<li>数据交互：MCA 系统会接收 IT 系统或管理员上传的复核结果文件&#x2F;状态数据。</li>
</ul>
<p>B. 财务类控制点</p>
<ul>
<li>Control：会计分录 &gt; X 美金需主管审批</li>
<li>Monitoring：监控“审批流程执行情况”</li>
<li>监控什么：当期抽样分录里，是否有缺少审批的记录，异常率多少。</li>
<li>数据交互：MCA 系统通过接口&#x2F;API 从财务系统（如 Oracle ERP, SAP）拉取抽样数据，或由业务部门上传抽样报告。</li>
</ul>
<p>C. 人事合规类控制点</p>
<ul>
<li>Control：新员工必须在 30 天内完成合规培训</li>
<li>Monitoring：监控“培训完成率”</li>
<li>监控什么：员工培训系统（LMS）的课程完成状态（完成&#x2F;未完成），统计完成率。</li>
<li>数据交互：MCA 系统通过接口调用 LMS 系统的数据，或定期导入报表。</li>
</ul>
<p>D. 运营流程类控制点</p>
<ul>
<li>Control：客户投诉需在 5 个工作日内处理完毕</li>
<li>Monitoring：监控“处理时效”</li>
<li>监控什么：CRM 系统中，投诉单的关闭时长是否 ≤ 5 天，异常单数量。</li>
<li>数据交互：MCA 系统定期获取 CRM 系统的工单处理数据，做规则计算。</li>
</ul>
<h4 id="Monitoring-怎么跑"><a href="#Monitoring-怎么跑" class="headerlink" title="Monitoring 怎么跑"></a>Monitoring 怎么跑</h4><p>数据获取</p>
<ul>
<li>API&#x2F;接口：MCA 调用外部系统的服务（如 HR、ERP、LMS）。</li>
<li>ETL&#x2F;数据仓库：MCA 读取公司统一的 Data Lake&#x2F;ODS 里的指标数据。</li>
<li>手工上传：业务部门导出 Excel&#x2F;CSV，再导入 MCA 系统。</li>
</ul>
<p>指标计算</p>
<ul>
<li>MCA 内部有逻辑，把 Control 定义的条件翻译成计算公式。</li>
</ul>
<p>例如：</p>
<p>培训完成率 &#x3D; 完成人数 ÷ 应参加人数<br>权限复核完成率 &#x3D; 已完成系统数 ÷ 总系统数</p>
<p>阈值对比</p>
<ul>
<li>把计算结果和 Control 定义的目标（100%、95% 等）对比。</li>
</ul>
<p>结果展示&#x2F;告警</p>
<ul>
<li>如果达标 → 绿色（Pass）</li>
<li>未达标 → 红色（Fail），可能生成 Issue 或 Task。</li>
</ul>
<h4 id="数据获取方式"><a href="#数据获取方式" class="headerlink" title="数据获取方式"></a>数据获取方式</h4><ol>
<li>接口对接（API &#x2F; 服务调用）</li>
</ol>
<ul>
<li>在花旗，很多核心系统都有标准接口（或者通过中台服务暴露数据），MCA 可以通过接口定期拉取数据：</li>
</ul>
<p>HR 系统（Workday &#x2F; PeopleSoft）</p>
<p>Monitoring：员工入职&#x2F;离职流程是否按规定完成（比如离职当天是否关停系统权限）。</p>
<p>实现：MCA 调用 HR 系统的 API，获取员工状态和时间戳数据。</p>
<ul>
<li>LMS（Learning Management System，培训系统）</li>
</ul>
<p>Monitoring：年度合规培训完成率。</p>
<p>实现：MCA 调接口拿到培训完成情况，计算完成率。</p>
<ul>
<li>ERP&#x2F;财务系统（Oracle ERP, SAP）</li>
</ul>
<p>Monitoring：高风险分录是否有二次审批。</p>
<p>实现：MCA 调用 ERP 接口获取分录审批日志。</p>
<p>👉 特点：适合数据标准化、实时性要求高的场景。</p>
<p>在花旗很多老系统（特别是地区性或遗留系统）并没有 API，这时就靠报表导入。</p>
<p>例子 1：访问权限复核</p>
<ul>
<li><p>Control：每季度必须复核用户权限。</p>
</li>
<li><p>Monitoring：检查复核是否完成。</p>
</li>
<li><p>实现：系统管理员从 IAM&#x2F;Active Directory 导出 CSV 报表，上传到 MCA。MCA 自动解析，打勾是否完成。</p>
</li>
</ul>
<p>例子 2：交易抽样检查</p>
<ul>
<li><p>Control：关键业务交易需抽样核查。</p>
</li>
<li><p>Monitoring：异常率统计。</p>
</li>
<li><p>实现：业务部门从交易系统导出 Excel 上传，MCA 自动算异常比例。</p>
</li>
</ul>
<p>👉 特点：适合跨地区、不统一的老系统；靠“人-系统”结合。</p>
<p>有些控制点没法通过数据直接验证，只能靠责任人手工确认。</p>
<p>例子 1：委员会&#x2F;例会是否召开</p>
<ul>
<li><p>Control：季度风险委员会必须召开一次。</p>
</li>
<li><p>Monitoring：检查会议纪要是否提交。</p>
</li>
<li><p>实现：责任人在 MCA 上勾选“已召开”，并上传会议纪要 PDF。</p>
</li>
</ul>
<p>例子 2：政策更新</p>
<ul>
<li><p>Control：年度合规政策需更新。</p>
</li>
<li><p>Monitoring：检查政策文件是否发布。</p>
</li>
<li><p>实现：责任人手工上传新文件。</p>
</li>
</ul>
<p>例子 3：供应商尽职调查</p>
<ul>
<li><p>Control：供应商需每年重新尽调。</p>
</li>
<li><p>Monitoring：业务人员手动填写完成状态，附上尽调报告。</p>
</li>
</ul>
<h3 id="业务完整逻辑"><a href="#业务完整逻辑" class="headerlink" title="业务完整逻辑"></a>业务完整逻辑</h3><p>GPMP创建之后，表示这是某个需要做风控的操作流程，这一部分是印度team负责的，我们就不是很清楚。</p>
<p>在我们系统中可以创建Control来挂载到某个Process上，填好相应的需要监控的指标和数值（比如合规完成率、员工入职&#x2F;离职流程、财务分录是否有二次审批）。</p>
<p>Monitoring根据control对应的process类型和设置的监控指标来获取数据，可以选择全自动&#x2F;半自动&#x2F;全手动的方式进行，然后就定期执行监控，根据设定的阈值进行预警</p>
<p>Testing就是定期抽样检查是否真的执行，可以理解成，monitoring是一个提醒用户的东西，testing则是生成最终的报告，testing出来的结果就是你这个control是否有效的唯一凭证。</p>
<p>control创建后status会变成Draft-Pending-Initiate,同时创建两个MTTool Creation Task，由该control的owner或者delegate进行填写，填写完成后会生成下一个Task，control进入下一个status Draft-Pending-Approve, 字段中填写的责任监管人会收到这个Task，选择approve&#x2F;reject。</p>
<p>JBPM流程：创建Process，并且在该processID下创建M&#x2F;T Task,并且返回给用户，用户那边每次完成task都会call workflow service这边一个TaskId完成，两个TaskID都完成的话就会创建一个IBRC-Approve Task。然后接着完成。</p>
<h3 id="SQL1000"><a href="#SQL1000" class="headerlink" title="SQL1000"></a>SQL1000</h3><ul>
<li>场景</li>
</ul>
<p>Oracle 对单条 SQL 的 IN 列表有限制：最多 1000 个元素，如果你的查询涉及多个 IN 列表，问题会更加明显</p>
<p>目标：提高性能并避免 ORA-01795 错误</p>
<ul>
<li><p>方案 A：拆分 IN 列表 + OR 连接</p>
<p>  SQL 可读性差：IN 列表越大，SQL 越长</p>
<p>  执行计划复杂：每个 IN 块会生成单独的访问路径，Oracle 需要分别优化每个 OR 条件</p>
<p>  性能下降：大量 OR 会增加解析时间，尤其是索引扫描时，可能会触发全表扫描</p>
<p>  总结：对于小量 IN 块可以接受，但大量数据（几千、几万）会明显慢</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlInterceptor</span> <span class="keyword">implements</span> <span class="title">StatementInspector</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">inspect</span><span class="params">(String sql)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;&gt;&gt;&gt; SQL: &quot;</span> + sql);</span><br><span class="line">        <span class="comment">// 你可以在这里修改 SQL，比如替换 IN 子句</span></span><br><span class="line">        <span class="keyword">return</span> sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>方案 B：使用 XMLTable</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> t.<span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">table</span> t</span><br><span class="line"><span class="keyword">JOIN</span> XMLTable(</span><br><span class="line">      <span class="string">&#x27;/ids/id&#x27;</span> PASSING xmltype(:xmlList)</span><br><span class="line">      COLUMNS id NUMBER PATH <span class="string">&#x27;.&#x27;</span></span><br><span class="line">) x</span><br><span class="line"><span class="keyword">ON</span> t.col <span class="operator">=</span> x.id;</span><br></pre></td></tr></table></figure>

<p>可维护性好：SQL 简洁，参数量几万也没问题</p>
<p>可扩展性强：动态生成 XML 或临时表即可支持任意大小的数据列表</p>
<p>缺点</p>
<p>需要额外构建 XML 或临时表，但成本低于 SQL 执行消耗</p>
<p>临时表要管理生命周期（全局临时表每天重建或 SESSION 级别）</p>
<ul>
<li>为什么 XMLTable&#x2F;临时表更快？</li>
</ul>
<p>优化器优化更好：IN OR IN 会生成多条访问路径，优化器无法高效合并</p>
<p>减少 SQL 解析时间：长 IN 列表会导致 SQL 文本巨大，解析成本高</p>
<p>减少 OR 条件处理开销：OR 条件的代价高，尤其涉及索引扫描</p>
<p>批量数据访问友好：JOIN 或 XMLTable 可以直接通过集合操作，高效使用缓存和索引</p>
<p>总结：当 IN 列表超过几千，甚至上万时，XMLTable 或临时表方案显著优于拆分 OR 的方案，尤其是在金融&#x2F;风控场景的高并发、大数据查询中。</p>
<ul>
<li>不用临时表的原因</li>
</ul>
<ol>
<li>临时表适合于用于复杂的场景，可以建索引，可以存储sql运行过程中的中间值，方便做join操作，但是我们的场景下需要的只是一个list全扫描的功能，用不到临时表；</li>
<li>OracleDB和Mysql不一样，Mysql创建临时表会话结束就会自动销毁,OracleDB则是表结构一直存在，那对于我们有多个List的场景就不太适配，因为我们也不知道最后会有多少的超过1000的List；OracleDB只能选择删除数据，除非手动Drop表；</li>
</ol>
<h4 id="实际写的时候遇到的问题"><a href="#实际写的时候遇到的问题" class="headerlink" title="实际写的时候遇到的问题"></a>实际写的时候遇到的问题</h4><ul>
<li>代码经过编译之后，参数名称变成var1,var2这种，需要用Param获取一下</li>
<li>需要注入Spring管理的Entitymanager，否则不在当前事务内</li>
<li>根据返回的结果类型来确定使用哪一个resultHandler</li>
</ul>
<h3 id="Transactional"><a href="#Transactional" class="headerlink" title="@Transactional"></a>@Transactional</h3><p>@Transactional 注解对同一个库的不同schema会生效，但是对不同库的不会生效，本质上是根据datasource来的。</p>
<h4 id="传播行为"><a href="#传播行为" class="headerlink" title="传播行为"></a>传播行为</h4><table>
<thead>
<tr>
<th>传播级别</th>
<th>行为</th>
<th>典型场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>REQUIRED</code></td>
<td>加入已有事务或新建</td>
<td>大部分业务方法</td>
</tr>
<tr>
<td><code>REQUIRES_NEW</code></td>
<td>总是新建事务，挂起已有事务</td>
<td>审计日志、异步通知，失败不能影响主事务</td>
</tr>
<tr>
<td><code>SUPPORTS</code></td>
<td>有事务加入，无事务非事务执行</td>
<td>可选事务操作</td>
</tr>
<tr>
<td><code>MANDATORY</code></td>
<td>必须在事务中执行</td>
<td>核心业务强制要求事务</td>
</tr>
<tr>
<td><code>NOT_SUPPORTED</code></td>
<td>挂起当前事务，以非事务执行</td>
<td>大数据导出、读历史数据无需锁</td>
</tr>
<tr>
<td><code>NEVER</code></td>
<td>必须非事务执行</td>
<td>非事务场景保证不加锁</td>
</tr>
<tr>
<td><code>NESTED</code></td>
<td>当前事务存在则创建子事务保存点</td>
<td>可以局部回滚，数据库支持保存点（如 Oracle、MySQL InnoDB）</td>
</tr>
</tbody></table>
<p>这个传播行为是指被传播的时候的行为，而不是传播到下一个的时候的行为。本质上就是，用了这个传播级别了，每次访问数据库的时候的auto-commit就会不生效，而是由@Transactional来控制，相当于应用层面控制了事务。</p>
<p><code>nested</code>和<code>required_new</code>的区别，在于requiredNew的两个事务完全不影响，但是nested中后面的子事务会被父事务的回滚影响到</p>
<ul>
<li>保存点的原理</li>
</ul>
<ol>
<li><p>事务日志（Redo&#x2F;Undo log）：数据库在执行事务操作时，会把修改记录到 Undo Log（用于回滚）和 Redo Log（用于重做或崩溃恢复）。</p>
</li>
<li><p>创建保存点：当你 SAVEPOINT sp1; 时，数据库内部会记录一个指针（offset&#x2F;标记），标记当前 Undo Log 的位置。</p>
</li>
<li><p>回滚到保存点：执行 ROLLBACK TO sp1; 时，数据库会把事务撤销到这个标记位置，即只回滚保存点之后的操作。</p>
</li>
<li><p>释放保存点：执行 RELEASE SAVEPOINT sp1;，数据库会删除该保存点，节省内存。</p>
</li>
</ol>
<p>所以保存点实际上就是 事务内部的一个“回滚标记”，通过 Undo Log 回退操作，不会像完整回滚那样撤销整个事务。</p>
<h4 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h4><table>
<thead>
<tr>
<th>类型</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>DEFAULT</code></td>
<td>使用数据库默认隔离级别</td>
</tr>
<tr>
<td><code>READ_UNCOMMITTED</code></td>
<td>允许读取未提交数据（脏读）</td>
</tr>
<tr>
<td><code>READ_COMMITTED</code></td>
<td>只能读已提交数据（避免脏读）</td>
</tr>
<tr>
<td><code>REPEATABLE_READ</code></td>
<td>读到的数据在整个事务中一致（防止不可重复读）</td>
</tr>
<tr>
<td><code>SERIALIZABLE</code></td>
<td>串行化执行，完全隔离，最严格（防止幻读）</td>
</tr>
</tbody></table>
<p>搭配propagation使用的，加入当前方法创建了一个新的事务，这个事务就按照这个隔离级别来，可以控制是否能够看到上层的修改。</p>
<h4 id="其他参数"><a href="#其他参数" class="headerlink" title="其他参数"></a>其他参数</h4><ul>
<li>readOnly: boolean,提示数据库这个操作是否只读</li>
<li>timeout: 超时时间</li>
<li>rollbackFor&#x2F;noRollbackFor: 指定哪些Exception回滚，哪些不回滚</li>
<li>value&#x2F;transactionManager: 适用于多数据源场景</li>
</ul>
<p>在进入方法前，会去获取一个Datasource，如果有多个dataSource就指定名称或者@Primary，多个datasource的情况下需要自己配置TransactionManager。核心流程就是 ： <code>datasource-&gt;拿这个datasource对应的jpaProperty-&gt;两个一起构建一个EntityManager-&gt;再把EntityManager注册到TransactionManager</code>,比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">        basePackages = &quot;com.weirdo.stockanalysis.dao.mysql&quot;,   // mysql的repository目录</span></span><br><span class="line"><span class="meta">        entityManagerFactoryRef = &quot;mysqlEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">        transactionManagerRef = &quot;mysqlTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MysqlDataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;mysqlDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.mysql&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">mysqlDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;mysqlEntityManagerFactory&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title">mysqlEntityManagerFactory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@Qualifier(&quot;mysqlEntityManagerFactoryBuilder&quot;)</span> EntityManagerFactoryBuilder builder,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@Qualifier(&quot;mysqlDataSource&quot;)</span> DataSource dataSource</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> builder</span><br><span class="line">                .dataSource(dataSource)</span><br><span class="line">                .packages(<span class="string">&quot;com.weirdo.stockanalysis.entity.mysql&quot;</span>) <span class="comment">// mysql的实体类目录</span></span><br><span class="line">                .persistenceUnit(<span class="string">&quot;mysql&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;mysqlTransactionManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">mysqlTransactionManager</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="meta">@Qualifier(&quot;mysqlEntityManagerFactory&quot;)</span> EntityManagerFactory entityManagerFactory</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JpaTransactionManager(entityManagerFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;mysqlEntityManagerFactoryBuilder&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EntityManagerFactoryBuilder <span class="title">mysqlEntityManagerFactoryBuilder</span><span class="params">(<span class="meta">@Qualifier(&quot;mysqlJpaProperties&quot;)</span> JpaProperties jpaProperties)</span> </span>&#123;</span><br><span class="line">        JpaVendorAdapter jpaVendorAdapter = createJpaVendorAdapter(jpaProperties);</span><br><span class="line">        Function&lt;DataSource, Map&lt;String, ?&gt;&gt; jpaPropertiesFactory =</span><br><span class="line">                (dataSource) -&gt; jpaProperties.getProperties();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EntityManagerFactoryBuilder(jpaVendorAdapter, jpaPropertiesFactory, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> JpaVendorAdapter <span class="title">createJpaVendorAdapter</span><span class="params">(JpaProperties jpaProperties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HibernateJpaVendorAdapter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.jpa.mysql&quot;)</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;mysqlJpaProperties&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JpaProperties <span class="title">mysqlJpaProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JpaProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h3><h4 id="组成部分："><a href="#组成部分：" class="headerlink" title="组成部分："></a>组成部分：</h4><ul>
<li>Aspect（切面）：横切逻辑本身，如日志记录。</li>
<li>Join point（连接点）：程序执行中的点，如方法调用、异常抛出。</li>
<li>Pointcut（切入点）：定义在哪些 join point 执行 Aspect。</li>
<li>Advice（通知）：具体的横切逻辑（前置、后置、环绕等）。</li>
<li>Weaving（织入）：将切面逻辑与业务逻辑结合的过程。</li>
</ul>
<h4 id="SpringAOP"><a href="#SpringAOP" class="headerlink" title="SpringAOP"></a>SpringAOP</h4><p>默认CGLIB，可以通过配置修改</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">spring.aop.proxy-target-class=false</span>  <span class="comment"># 强制使用 JDK动态代理</span></span><br></pre></td></tr></table></figure>

<p>源码中表明，如果即使设置成true，当代理对象传入的是个接口的时候，仍然会使用JDK动态代理</p>
<ul>
<li>AOP能否拦截类的非interface中的public方法？</li>
</ul>
<p>需要看切点是切的接口还是切的实现类，如果切点设置的是接口就不能代理，如果设置的是类就能代理</p>
<ul>
<li><p>代理生成流程</p>
</li>
<li><p><code>AnnotationAwareAspectJAutoProxyCreator</code></p>
<p>  扫描容器里的 Bean，判断哪些 Bean 需要代理（匹配切点）。</p>
<p>  调用 wrapIfNecessary() 生成代理对象。</p>
</li>
<li><p>ProxyFactory</p>
<p>  负责生成最终的代理对象。</p>
</li>
<li><p>原始 Bean 实例化完成后，<code>AnnotationAwareAspectJAutoProxyCreator</code>的<code>postProcessAfterInitialization</code> 会：</p>
<p>  判断该 Bean 是否需要切面拦截。</p>
<p>  如果需要，生成一个代理对象。</p>
<p>  返回的就是代理对象，Spring 容器里的引用就被代理对象替代了。</p>
</li>
</ul>
<h4 id="PointCut-语法"><a href="#PointCut-语法" class="headerlink" title="PointCut 语法"></a>PointCut 语法</h4><ul>
<li>execution</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 拦截所有包下的服务类的所有 public 方法</span></span><br><span class="line"><span class="meta">@Pointcut(&quot;execution(public * com.example.service.*.*(..))&quot;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>within</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 匹配 com.example.service 包内所有类的所有方法</span></span><br><span class="line"><span class="meta">@Pointcut(&quot;within(com.example.service..*)&quot;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>args</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 拦截所有第一个参数是 String 类型的方法</span></span><br><span class="line"><span class="meta">@Pointcut(&quot;args(java.lang.String, ..)&quot;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>this&#x2F;target</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut(&quot;this(com.example.service.MyService)&quot;)</span></span><br><span class="line"><span class="meta">@Pointcut(&quot;target(com.example.service.MyServiceImpl)&quot;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>annotation</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut(&quot;target(com.example.service.MyServiceImpl)&quot;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>组合表达式</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.example.service 包内所有方法，排除测试类</span></span><br><span class="line"><span class="meta">@Pointcut(&quot;within(com.example.service..*) &amp;&amp; !within(com.example.service..*Test)&quot;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>AOP 中的 JoinPoint 和 ProceedingJoinPoint 有什么区别？<br>JoinPoint → 获取方法参数、签名<br>ProceedingJoinPoint → 可执行目标方法（用于 @Around）\</p>
</li>
<li><p>为什么同类内部方法调用 AOP 不生效？</p>
</li>
</ul>
<p>因为 Spring AOP 依赖代理，self 调用不会经过代理对象，可以使用 AopContext.currentProxy() 调用自己通过注入代理对象自己调用</p>
<ul>
<li>Spring AOP 和事务的关系？</li>
</ul>
<p>@Transactional 本质就是基于 AOP 的动态代理 + 事务切面</p>
<ul>
<li>多个切面执行顺序如何控制？</li>
</ul>
<p>@Order 注解控制优先级，值越小优先级越高</p>
<h4 id="编程式使用AOP"><a href="#编程式使用AOP" class="headerlink" title="编程式使用AOP"></a>编程式使用AOP</h4><ul>
<li>可以通过继承实现Pointcut接口，通过编程方式定义pointcut。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.ClassFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.MethodMatcher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.Pointcut;</span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 自定义Pointcut</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Elim</span></span><br><span class="line"><span class="comment"> * 2017年5月8日</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCustomPointcut</span> <span class="keyword">implements</span> <span class="title">Pointcut</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClassFilter <span class="title">getClassFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyCustomClassFilter();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MethodMatcher <span class="title">getMethodMatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyCustomMethodMatcher();</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCustomClassFilter</span> <span class="keyword">implements</span> <span class="title">ClassFilter</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//实现自己的判断逻辑，这里简单的判断对应Class的名称是以Service结尾的就表示匹配</span></span><br><span class="line">            <span class="keyword">return</span> clazz.getName().endsWith(<span class="string">&quot;Service&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCustomMethodMatcher</span> <span class="keyword">implements</span> <span class="title">MethodMatcher</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Method method, Class&lt;?&gt; targetClass)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//实现方法匹配逻辑</span></span><br><span class="line">            <span class="keyword">return</span> method.getName().startsWith(<span class="string">&quot;find&quot;</span>);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRuntime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Method method, Class&lt;?&gt; targetClass, Object[] args)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>可以通过实现<code>MethodBeforeAdvice</code>,<code>AfterReturningAdvice</code>,<code>MethodInterceptor</code>等来实现Advice</li>
</ul>
<h4 id="AOP本质实现"><a href="#AOP本质实现" class="headerlink" title="AOP本质实现"></a>AOP本质实现</h4><p>通过使用字节码操作的工具，生成被代理的类，并且在切点前后放入我们自己设置的代码逻辑</p>
<ul>
<li>SpringAOP：</li>
</ul>
<ol>
<li>读取@Aspect注解的类，生成对应的Advice对象</li>
<li><code>AnnotationAwareAspectJAutoProxyCreator</code>会成为<code>BeanPostProcessor</code>，当Bean创建完成后调用<code>postProcessAfterInitialization(bean, beanName)</code></li>
<li>通过<code>wrapIfNecessary(bean, beanName)</code>根据是否有适用的Advice判断是否需要代理（即是否满足切点）。不需要代理的话直接返回原本创建好的bean</li>
<li>需要代理的话会创建代理，将Advic列表的被代理的对象传给ProxyFactory,生成具体的代理对象并且返回作为这个bean注册到容器中，之后有地方注入了这个bean，调用的都是代理对象</li>
<li>代理类型根据是否强制设置CGLIB和代理的是否有接口来决定用JDK还是CGLIB</li>
<li>执行方法的时候会进入<code>InvocationHandler.invoke()</code>或者<code>MethodInterceptor.intercept()</code></li>
<li>根据advice列表生成拦截器链，然后再invoke中顺序调用</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JdkDynamicAopProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdvisedSupport advised;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> </span>&#123;</span><br><span class="line">        List&lt;Object&gt; chain = <span class="keyword">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (chain.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(target, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ReflectiveMethodInvocation(target, method, args, chain).proceed();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>CGLIB: 在CGLIB框架在创建代理对象的过程中，通过创建一个Enhancer对象，为其设置超类Class、回调函数。接着从其超类(目标类)的Class对象中获取所有Method对象，最终过滤出非final、非static的public修饰的方法，接着调用ASM框架的相关API去做一些创建类的信息、字段信息、方法信息等，将它们创建为一个byte字节组成的数组，即字节码对象。再通过ASM框架将程序内存中的字节码对象以Class文件写入指定路径（非必须步骤，需要自行设置），最后将得到的字节码对象转为代理Class对象以及回调函数通过反射创建一个实例对象。</li>
</ul>
<h4 id="AspectJ"><a href="#AspectJ" class="headerlink" title="AspectJ"></a>AspectJ</h4><p>可以拦截private, 构造方法和静态方法，因为他是在编译期间就把切面逻辑写到.class文件中，类加载的时候会修改其字节码，实现切面的插入</p>
<h3 id="CompletableFuture"><a href="#CompletableFuture" class="headerlink" title="CompletableFuture"></a>CompletableFuture</h3><p>在调用查数据的时候，比如用户点进Control详情页面，就需要并行调用三个服务获取数据，<code>Gpmp, Monitoring, Testing</code>，这时候同步调用这三个服务能显著提升性能。</p>
<p>不同的异步方案对比</p>
<p><img src="https://i.imgur.com/n44WE3Y.png" alt="picture 0">  </p>
<h4 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h4><ul>
<li>cf1.thenApply(cf2)</li>
</ul>
<ol>
<li>将观察者Completion(UniApply)注册到cf1，cf1将这个Uniapply压到Completion栈中</li>
<li>cf1完成的时候，结果保存到result</li>
<li>依次弹出栈中的XxxApply，通知观察者(cf2)尝试运行</li>
</ol>
<ul>
<li>cf3&#x3D;cf1.thenCombine(cf2)</li>
</ul>
<p>跟上面基本一致，区别在于当cf1完成的时候会通知BiApply一次，cf2完成时也通知BiApply一次，只有当BiApply判断出两个cf都执行完了，才会启动cf3</p>
<ul>
<li>cf4&#x3D;CompletableFuture.allof(cf1,cf2,cf3)</li>
</ul>
<p>跟上面也基本一致，区别在于，这里也是用BiApply,只不过是all里面从前往后地构成一个树结构，执行的结果层层通知下去</p>
<h4 id="ForkJoinPool"><a href="#ForkJoinPool" class="headerlink" title="ForkJoinPool"></a>ForkJoinPool</h4><p>Fork&#x2F;Join 框架基于”工作窃取”算法 (Work Stealing Algorithm)，该算法的核心思想是每个工作线程有自己的任务队列(双端队列, Deque)。当一个线程完成了自己队列中的任务时，便会窃取其他线程队列中的任务执行，这样就不会因为某个线程在等待而浪费 CPU 资源。</p>
<p>需要手动创建ForkJoinTask，task内部是递归形式构建子任务，这样才能利用到ForkJoinPool的fork&#x2F;join特性，如果只是传入一个Runable&#x2F;Callable，那本质上和普通线程池差不多</p>
<p>Fork&#x2F;Join 框架非常适合以下这些工作负载：</p>
<p>递归任务：如斐波那契数列、归并排序等分治算法。<br>大规模数据处理：快速对集合、数组等进行并行操作。<br>图像处理：图像处理等数据量大的任务可以被分成多个小任务并行处理。</p>
<p>一定要注意异步RPC调用的情况下如果是基于异步NIO的方式的话，要用CompletableFuture的异步回调，否则可能长期占用IO线程，影响服务响应</p>
<p>比如说： <code>async.call()</code> 会返回一个<code>CompletableFuture&lt;xxx&gt;</code>，这时候回调函数最好写成<code>.thenSupplyAsync(xxx)</code>，这样就不会用IO线程来执行回调</p>
<h3 id="HttpExchange"><a href="#HttpExchange" class="headerlink" title="HttpExchange"></a>HttpExchange</h3><h4 id="HttpExchange的实现方式"><a href="#HttpExchange的实现方式" class="headerlink" title="HttpExchange的实现方式"></a>HttpExchange的实现方式</h4><p>HttpExchange本身是一个接口，不涉及实现，具体的实现得看你用什么Client，可以用RestClient&#x2F;Webclient不同的实现有不同的效果</p>
<h4 id="HttpExchange是阻塞的还是异步的"><a href="#HttpExchange是阻塞的还是异步的" class="headerlink" title="@HttpExchange是阻塞的还是异步的"></a>@HttpExchange是阻塞的还是异步的</h4><ol>
<li>直接返回类或者list这种，是阻塞的</li>
<li>支持返回Mono&#x2F;Flux类型，这种是异步的，可以通过Mono.zip(xServiceClient.callXX(),yServiceClient.call())</li>
</ol>
<h4 id="Mono-x2F-Flux-reactive-call"><a href="#Mono-x2F-Flux-reactive-call" class="headerlink" title="Mono&#x2F;Flux reactive call"></a>Mono&#x2F;Flux reactive call</h4><p><code>Mono&lt;User&gt; userMono = userServiceClient.getUser(&quot;123&quot;);</code> 像这样的代码是不会执行调用client的，必须得<code>userMono.subscribe()/userMono.block()</code>之后才可以</p>
<p>也可以很方便的转成CompletableFuture类型 <code>userMono.toFuture()</code></p>
<h4 id="发布-x2F-订阅模式"><a href="#发布-x2F-订阅模式" class="headerlink" title="发布&#x2F;订阅模式"></a>发布&#x2F;订阅模式</h4><p>通常我们调用的时候使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;User&gt; mono = userServiceClient.getUser(<span class="string">&quot;123&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户只写了 Consumer 回调，没有写 Subscriber</span></span><br><span class="line">Disposable disposable=mono.subscribe(user -&gt; System.out.println(<span class="string">&quot;Got user: &quot;</span> + user.getName()));</span><br></pre></td></tr></table></figure>

<p>实际上框架内部会把我们传给subscribe的这个Consumer封装成一个subscriber，然后返回给你一个句柄类似的东西，你可以选择disposable.dispose()，就会停掉这个订阅者。</p>
<p>subscriber是没有返回值的，因为响应式操作推荐流式传递和处理数据，如果有数据需要在获取后做转化，可以使用<code>map/flatMap</code>，flatMap是处理返回值为<code>Mono&lt;Mono&gt;</code>这种嵌套情况的，他会帮你自动展开，如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Mono&lt;User&gt; updatedMono =</span><br><span class="line">        userMono.map(m -&gt; &#123;</span><br><span class="line">            m.setId(<span class="number">123</span>);</span><br><span class="line">            <span class="keyword">return</span> m; <span class="comment">// ✅ 这里的 return 会进入下一个 Mono</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">Mono&lt;Address&gt; addressMono = userMono.</span><br><span class="line">flatMap(user -&gt; addressService.getAddress(user.getId()));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>所有的流式操作都以<code>.subscribe()</code>作为起点开始真正的执行，中间的<code>map/doOnNext/doOnComplete</code>都是在做一些中间的操作，类似于声明式的Stream编程</p>
<h3 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h3><p>项目中通过消息队列的方式通知进行报表的生成和拉取，这一部分是丢给线程池做的，由于年初的内部审查需求，大量部门发送了生成报表的请求，并被转发到listener，导致线程池的任务队列打满，无法向broker发送心跳</p>
<p>@KafkaListener 本质是 对 Kafka 消费线程的封装</p>
<p>Spring Boot 启动时，KafkaListenerAnnotationBeanPostProcessor 会扫描 @KafkaListener 注解的方法，并注册一个 KafkaMessageListenerContainer</p>
<p>这个容器内部会创建 KafkaConsumer（Java client）并启动一个或多个线程（concurrency 控制并发数量）</p>
<ul>
<li>解决方案：</li>
</ul>
<ol>
<li>增加了任务队列的长度</li>
<li>调大了poll的间隔时间</li>
<li>优化了excel生成的逻辑</li>
</ol>
<h4 id="消费者组"><a href="#消费者组" class="headerlink" title="消费者组"></a>消费者组</h4><table>
<thead>
<tr>
<th>功能</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>唯一消费</td>
<td>组内每条消息只被一个消费者处理</td>
</tr>
<tr>
<td>并行消费</td>
<td>多个消费者同时消费多个分区，提高吞吐量</td>
</tr>
<tr>
<td>弹性扩展</td>
<td>增加消费者，自动分配更多分区</td>
</tr>
<tr>
<td>容错</td>
<td>消费者挂掉 → 分区被其他消费者接管</td>
</tr>
<tr>
<td>广播消费</td>
<td>不同消费者组可以独立消费同一主题，实现多业务逻辑处理</td>
</tr>
</tbody></table>
<p>Kafka topic的分区数量是在创建topic的时候指定的，也可以通过java代码实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NewTopic newTopic = new NewTopic(topic, 3, (short) 1);</span><br><span class="line">kafkaAdmin.createOrModifyTopics(newTopic);</span><br></pre></td></tr></table></figure>

<h4 id="Kafka如何保证信息不丢失"><a href="#Kafka如何保证信息不丢失" class="headerlink" title="Kafka如何保证信息不丢失"></a>Kafka如何保证信息不丢失</h4><ul>
<li>生产者：</li>
</ul>
<ol>
<li>配置ack&#x3D;all</li>
<li>配置retry和超时时间</li>
<li>配置enable.idempotence&#x3D;true</li>
</ol>
<ul>
<li>消费者:</li>
</ul>
<ol>
<li>手动提交commit，否则可能执行失败，但是自动commit了</li>
<li>业务端设置乐观锁或者相关机制，保证只处理一次</li>
</ol>
<h4 id="Kafka的Offset是怎么管理的"><a href="#Kafka的Offset是怎么管理的" class="headerlink" title="Kafka的Offset是怎么管理的"></a>Kafka的Offset是怎么管理的</h4><ul>
<li>存储位置：内部 Topic 存储，会周期性地将offset写入磁盘</li>
<li>保存的形式：groupId + topic + partition → offset，就是每个消费组对每个topic的每个partion都会维护一个offset</li>
<li>Springboot配置<code>enable-auto-commit=false</code>，并且自己配置一个<code>KafkaListenerContainerFactory</code>，设置其ackMode</li>
</ul>
<h4 id="消费者组-rebalance-是怎么发生的？"><a href="#消费者组-rebalance-是怎么发生的？" class="headerlink" title="消费者组 rebalance 是怎么发生的？"></a>消费者组 rebalance 是怎么发生的？</h4><ul>
<li>触发条件</li>
</ul>
<ol>
<li>消费者组成员变化：新消费者加入组&#x2F;消费者退出组（正常退出或崩溃）</li>
<li>Topic 分区变化：Topic 增加或减少分区（一般增加，Kafka 不支持减少分区）</li>
<li>会话超时：消费者在 session.timeout.ms 时间内未发送心跳给 Group Coordinator → 被认为死掉 → 触发 Rebalance</li>
</ol>
<h4 id="数据库事务和kafka事务合并"><a href="#数据库事务和kafka事务合并" class="headerlink" title="数据库事务和kafka事务合并"></a>数据库事务和kafka事务合并</h4><p>使用<code>ChainedTransactionManager</code>,在具体的处理方法上添加<code>@Transactional(transactionManager = &quot;chainedTransactionManager&quot;)</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public ChainedTransactionManager chainedTransactionManager(</span><br><span class="line">        PlatformTransactionManager dbTransactionManager,</span><br><span class="line">        KafkaTransactionManager&lt;String, String&gt; kafkaTransactionManager) &#123;</span><br><span class="line"></span><br><span class="line">    return new ChainedTransactionManager(dbTransactionManager, kafkaTransactionManager);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Kafka 延迟问题怎么排查？</li>
</ul>
<p>通过获取Kafka提供的API获取Kafka的Metrics，比如消息发送速率、请求发送耗时等</p>
<h4 id="Kafka-生产者和消费者常用配置优化点？"><a href="#Kafka-生产者和消费者常用配置优化点？" class="headerlink" title="Kafka 生产者和消费者常用配置优化点？"></a>Kafka 生产者和消费者常用配置优化点？</h4><ul>
<li>生产者：</li>
</ul>
<table>
<thead>
<tr>
<th>配置</th>
<th>默认值</th>
<th>优化建议</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>batch.size</code></td>
<td>16 KB</td>
<td>64~256 KB</td>
<td>消息批量发送，增大可提高吞吐，但增大延迟</td>
</tr>
<tr>
<td><code>linger.ms</code></td>
<td>0</td>
<td>5~50 ms</td>
<td>等待更多消息组成 batch，增加吞吐但可能增加延迟</td>
</tr>
<tr>
<td><code>compression.type</code></td>
<td>none</td>
<td>snappy &#x2F; lz4</td>
<td>压缩减少网络和磁盘负载，提高吞吐</td>
</tr>
<tr>
<td><code>acks</code></td>
<td>1</td>
<td>1 &#x2F; all</td>
<td>1 延迟低，all 更可靠但吞吐略低</td>
</tr>
<tr>
<td><code>max.in.flight.requests.per.connection</code></td>
<td>5</td>
<td>&lt;&#x3D; 5</td>
<td>保证消息顺序，如果设置太大可能消息乱序</td>
</tr>
<tr>
<td><code>buffer.memory</code></td>
<td>32 MB</td>
<td>64~256 MB</td>
<td>内存缓冲区，避免发送堵塞</td>
</tr>
</tbody></table>
<ul>
<li>消费者：心跳间隔时间，手动&#x2F;自动提交</li>
</ul>
<table>
<thead>
<tr>
<th>配置</th>
<th>默认值</th>
<th>优化建议</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>fetch.min.bytes</code></td>
<td>1</td>
<td>1 KB ~ 64 KB</td>
<td>每次 poll 拉取最小数据量，减少网络请求</td>
</tr>
<tr>
<td><code>fetch.max.bytes</code></td>
<td>50 MB</td>
<td>根据消息大小</td>
<td>控制最大拉取数据，避免单次 poll 太大阻塞</td>
</tr>
<tr>
<td><code>max.poll.records</code></td>
<td>500</td>
<td>500~2000</td>
<td>一次 poll 拉取记录数，影响批量处理吞吐</td>
</tr>
<tr>
<td><code>max.partition.fetch.bytes</code></td>
<td>1 MB</td>
<td>1~10 MB</td>
<td>每个分区最大拉取量，配合批量处理优化</td>
</tr>
<tr>
<td><code>fetch.max.wait.ms</code></td>
<td>500</td>
<td>10~100 ms</td>
<td>拉取等待时间，平衡吞吐和延迟</td>
</tr>
</tbody></table>
<h4 id="Kraft-x2F-raft"><a href="#Kraft-x2F-raft" class="headerlink" title="Kraft&#x2F;raft"></a>Kraft&#x2F;raft</h4><h5 id="Raft"><a href="#Raft" class="headerlink" title="Raft"></a>Raft</h5><p>Raft 是一种一致性算法，用于在分布式系统中维护一致的日志和状态。核心目标：</p>
<ul>
<li><p>Leader 选举：集群中选出一个 Leader 节点，处理客户端写请求</p>
</li>
<li><p>日志复制：Leader 接收到请求 → 写入本地日志 → 同步给 Followers → 达成一致</p>
</li>
<li><p>安全与容错：即使部分节点故障，只要大多数节点存活，系统依然可用<br>Followers 节点可以随时接收 Leader 日志复制</p>
</li>
</ul>
<p>Raft 是一种分布式一致性算法，用于在集群节点之间维护一致的日志和状态，保证即使部分节点宕机也能安全提交数据。KRaft 是 Kafka 对 Raft 的应用，它替代了原来依赖 ZooKeeper 的元数据管理，通过 Controller 节点选举 Leader 并复制元数据日志，保证 Topic、Partition、Broker 等元数据在集群中一致、高可用。简单来说，Raft 是算法，KRaft 是 Kafka 基于 Raft 的元数据管理实现。</p>
<h4 id="副本同步机制"><a href="#副本同步机制" class="headerlink" title="副本同步机制"></a>副本同步机制</h4><ul>
<li>数据写入时同步：根据ack的设置来</li>
<li>follower定期拉取：拉取当前的log end offset </li>
<li>ISR（In-Sync Replica）机制: Leader 只承认 ISR 中副本的数据为“已提交”（commit）</li>
</ul>
<h4 id="AppDynamic"><a href="#AppDynamic" class="headerlink" title="AppDynamic"></a>AppDynamic</h4><p>项目中在docker文件中配置java的启动命令，或者在lightspeed的web界面直接添加。</p>
<p>流程是：</p>
<ol>
<li>kubectl创建一个namespace，并且把appd的相关controller、port等信息在其中创建secret</li>
<li>应用的container启动前，先在initContainer的时候下载 agent.jar，然后挂载到目录上</li>
<li>应用container启动的时候把上面的secret获取到作为环境变量</li>
</ol>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-jdk-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制你的 Spring Boot jar</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> target/myapp.jar /app/myapp.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制 AppDynamics Agent</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> appdynamics-agent.jar /app/appdynamics-agent.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-javaagent:/app/appdynamics-agent.jar \</span></span><br><span class="line"><span class="string">-Dappdynamics.controller.hostName=controller.example.com \</span></span><br><span class="line"><span class="string">-Dappdynamics.controller.port=8090 \</span></span><br><span class="line"><span class="string">-Dappdynamics.agent.applicationName=MyApp \</span></span><br><span class="line"><span class="string">-Dappdynamics.agent.tierName=Backend \</span></span><br><span class="line"><span class="string">-Dappdynamics.agent.nodeName=Node1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动命令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> java <span class="variable">$JAVA_OPTS</span> -jar /app/myapp.jar</span></span><br></pre></td></tr></table></figure>

<h3 id="Seata"><a href="#Seata" class="headerlink" title="Seata"></a>Seata</h3><ul>
<li>增加队列长度和扩展线程数量（非最优）</li>
<li>优化excel生成逻辑</li>
<li>可以暂停消费（优选）</li>
</ul>
<p>需要建立一个新的seata数据库，其中放global_table,branch_table,distributed_lock,lock_table</p>
<p>我使用的是AT模式，所以会在我们业务库中创建一个undolog表，然后在需要分布式事务的地方增加@GlobalTransactional注解</p>
<ol>
<li>配置好tx_group和seata_server的地址,确保需要分布式事务的服务在一个group中</li>
<li>再配置用Seata的DataSourceProxy代理datasource，要确认好用<code>Hikari</code>还是<code>Druid</code></li>
<li>使用@GlobalTransactional</li>
</ol>
<table>
<thead>
<tr>
<th>表名</th>
<th>作用</th>
<th>存储核心信息</th>
</tr>
</thead>
<tbody><tr>
<td><code>global_table</code></td>
<td>全局事务记录</td>
<td>xid、全局事务状态、发起服务等</td>
</tr>
<tr>
<td><code>branch_table</code></td>
<td>分支事务记录</td>
<td>xid、branch_id、资源、状态、锁键</td>
</tr>
<tr>
<td><code>lock_table</code></td>
<td>行级锁（AT 模式）</td>
<td>row_key、xid、branch_id、锁状态</td>
</tr>
<tr>
<td><code>distributed_lock</code></td>
<td>TC 集群锁</td>
<td>resource_id、xid、lock_owner</td>
</tr>
</tbody></table>
<p>整个流程是：</p>
<ol>
<li>TM向TC申请一个XID，然后调用的时候传ID，涉及到global_transaction表</li>
<li>TC收到XID之后，注册一个分支事务，涉及到branch_transaction表，并且记录undolog</li>
<li>TM提交或者回滚的时候，告诉TC，TC会告诉RM</li>
<li>RM收到通知也会提交&#x2F;回滚，然后删除undolog</li>
</ol>
<h4 id="XA协议的2PC和3PC（强一致性）"><a href="#XA协议的2PC和3PC（强一致性）" class="headerlink" title="XA协议的2PC和3PC（强一致性）"></a>XA协议的2PC和3PC（强一致性）</h4><p>引入事务协调者，管理各个微服务，每个微服务是一个事务参与者</p>
<p>2PC：</p>
<ul>
<li>准备阶段： 协调者发送一个准备命令，每个事务参与者收到命令后，执行事务相关操作，但是不提交，然后参与者返回相应，告诉协调者是否准备成功</li>
<li>提交阶段：如果所有参与者都准备成功，就给他们发送一个提交命令；如果有一个参与者准备失败，就发送一个回滚命令</li>
</ul>
<p>优点是利用数据库自身功能完成本地事务的提交和回滚，不侵入业务代码<br>缺点是：会阻塞其他相同的请求，因为事务没有提交的情况下，会进行加锁； 资源浪费，如果一个参与者是挂掉的，那么肯定是要回滚的，那之前执行的事务操作就是浪费</p>
<p>3PC：</p>
<ul>
<li>准备阶段，判断是否每个参与者都正常运行，避免有人挂掉</li>
<li>预提交阶段：协调者发送预提交命令，参与者收到后，就执行事务，但不提交，返回协调者是否准备成功</li>
<li>提交阶段：如果全成功就提交，否则就回滚</li>
</ul>
<h4 id="AT模式（最终一致性）"><a href="#AT模式（最终一致性）" class="headerlink" title="AT模式（最终一致性）"></a>AT模式（最终一致性）</h4><p>Seeta最流行和最常用的事务模式。是基于Undo Log的最终一致性，undolog记录了数据的原始值（也就是数据快照），用于回滚数据。</p>
<ul>
<li>第一阶段：每个参与者直接执行事务相关操作，并且直接提交，同时把事务的原始值记录在undolog中</li>
<li>第二阶段：协调者根据所有参与者的执行结果，如果全成功，就通知参与者异步删除undolog；如果有人失败，就通知参与者根据undolog恢复数据并且删除undolog</li>
</ul>
<h4 id="Saga模式"><a href="#Saga模式" class="headerlink" title="Saga模式"></a>Saga模式</h4><p>Saga 模式是长事务补偿机制的一种实现方式。</p>
<p>核心思想：将一个全局事务拆成多个子事务，每个子事务完成后如果全局事务失败，就执行对应的补偿操作回滚之前的操作。</p>
<p>与 AT&#x2F;TCC 不同，Saga 不追求强一致性，而是保证 最终一致性。</p>
<h4 id="Seata-的事务角色有哪些？"><a href="#Seata-的事务角色有哪些？" class="headerlink" title="Seata 的事务角色有哪些？"></a>Seata 的事务角色有哪些？</h4><ul>
<li>TC (Transaction Coordinator，事务协调器)： 一般是单独部署的 Seata Server</li>
<li>TM (Transaction Manager，事务管理器)：事务的“发起人”，向 TC 发起开启&#x2F;提交&#x2F;回滚全局事务的请求；</li>
<li>RM (Resource Manager，资源管理器)：事务的“执行者”，向 TC 注册分支事务，根据 TC 的指令提交或回滚本地事务。</li>
</ul>
<h4 id="Seata-如何保证幂等性和防悬挂？"><a href="#Seata-如何保证幂等性和防悬挂？" class="headerlink" title="Seata 如何保证幂等性和防悬挂？"></a>Seata 如何保证幂等性和防悬挂？</h4><ul>
<li>幂等：当TM提交或者回滚的时候，TC会通知所有的RM，但是由于网络波动，TC没有收到RM的响应,TC会重试，就会导致重复提交；RM会判断branch_id对应的undolog的状态，已经完成就说明执行过了，就不会再执行了。</li>
<li>防悬挂：RM已经使用了逻辑行级锁来保证在RM分支事务执行期间，别的分支事务不能更改这一行，但是无法防止其他的业务的事务修改这一行，会导致undo的时候覆盖掉别人的修改。</li>
</ul>
<h4 id="Seata-Undo-Log-如何避免膨胀？"><a href="#Seata-Undo-Log-如何避免膨胀？" class="headerlink" title="Seata Undo Log 如何避免膨胀？"></a>Seata Undo Log 如何避免膨胀？</h4><p>undolog里面记录的是事务前的数据，所以回滚也是固定回滚到事务前。可以配置seata固定时间删除undolog</p>
<h4 id="vgroup-mapping-和-tx-service-group"><a href="#vgroup-mapping-和-tx-service-group" class="headerlink" title="vgroup-mapping 和 tx-service-group"></a>vgroup-mapping 和 tx-service-group</h4><ul>
<li>tx-service-group: Spring Boot 应用端的事务组标识,告诉 Seata Server（TC）“这个应用属于哪个全局事务组”，即 XID 会挂到这个组里。就是类似于，我这个应用在seata中叫这个名字，你生成的XID要放在这个名字下面</li>
<li>vgroup-mapping: tx-service-group在seata服务端的映射。诉 TC，“当某个 tx-service-group 提交&#x2F;回滚时，应该找到哪些 RM 去执行指令”。 就类似于，我有多个一个项目下有多个服务叫A,B,C 然后我希望他们在seata服务端都放在ABC这个集群下面；另一个项目下有D,E,F三个服务，我希望他们放在DEF这个集群下。</li>
</ul>
<p>这两个参数在Seata以集群模式部署下是有作用的，可以指定哪些tx-service-group交给哪个集群来处理，这样当某个集群出问题的时候，就可以快速切换集群</p>
<h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><h4 id="三大日志"><a href="#三大日志" class="headerlink" title="三大日志"></a>三大日志</h4><ul>
<li>binlog: 主从复制（Replication）;从库通过读取主库的 binlog 来同步数据。属于mysql级别的</li>
<li>redolog: 崩溃恢复时只重做已提交事务，数据库崩溃后，可以通过 redo log 恢复 最新的数据页。是几个文件循环写入的，属于InnoDB级别的</li>
<li>undolog：事务回滚日志，用于回滚事务和MVCC</li>
</ul>
<p>事务提交三阶段</p>
<ol>
<li><p>写 redo log（prepare 阶段）。</p>
</li>
<li><p>写 binlog（commit 阶段）。</p>
</li>
<li><p>redo log 标记为 commit。</p>
</li>
</ol>
<p>这样保证了：</p>
<p>崩溃时，如果 redo log 有 prepare 但 binlog 没有 commit，事务会回滚，保证主从一致。</p>
<p>崩溃时，如果 redo log 和 binlog 都写了，重启时就能用 redo log 恢复事务，保证不丢数据。</p>
<h4 id="分库分表"><a href="#分库分表" class="headerlink" title="分库分表"></a>分库分表</h4><ul>
<li>为什么要分库分表</li>
</ul>
<ol>
<li>单库单表数据量太大，查询&#x2F;写入性能下降。</li>
<li>单机磁盘、内存不足。</li>
<li>高并发下锁冲突严重，无法支撑业务。</li>
</ol>
<ul>
<li>分库和分表的区别</li>
</ul>
<ol>
<li>分表：把一张表的数据拆成多张表，通常还是在同一个数据库实例里。解决的是 <strong>单表数据量过大</strong> 的问题。</li>
<li>分库：把数据拆到不同的数据库实例，解决的是 <strong>数据库实例本身性能瓶颈</strong>（IO&#x2F;CPU&#x2F;存储）。</li>
</ol>
<ul>
<li>分库分表常见方式</li>
</ul>
<ol>
<li>水平拆分：按照某个字段取模、范围、哈希，把数据分散存储。</li>
<li>垂直拆分：按照业务&#x2F;表的功能，把不同表放到不同库里。</li>
</ol>
<ul>
<li>分库分表后的挑战</li>
</ul>
<ol>
<li>跨库 join（需要应用层聚合）： 两个表在一个库，可以直接执行；不在一个库，分别去两个库查询，在应用层进行join或者聚合操作</li>
<li>主键唯一性：可以用shardingsphere自带的分布式id生成器，41bit timestamp | 10bit machineId | 12bit sequence</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">t_order:</span><br><span class="line">  key-generator:</span><br><span class="line">    column: order_id</span><br><span class="line">    type: SNOWFLAKE 使用snowflake生成主键id</span><br></pre></td></tr></table></figure>

<ul>
<li><p>数据迁移、扩容（需要数据迁移方案，避免热点）。</p>
</li>
<li><p>扩容怎么做</p>
</li>
</ul>
<ol>
<li>一开始一般选 2 的倍数个分片，比如 4 库 16 表。</li>
<li>扩容时一般采用 双写 + 数据迁移 + 平滑切换 的方案。</li>
</ol>
<p>数据库扩容时，如果风险可控，可以直接切写，将应用写操作切换到新库；如果需要平滑迁移，通常会先双写一段时间，让老库和新库同时写入并保持同步，验证新库数据无误后再切写。双写可以降低切库风险，但需要处理事务一致性和失败重试问题。</p>
<h4 id="路由ID（分片键）"><a href="#路由ID（分片键）" class="headerlink" title="路由ID（分片键）"></a>路由ID（分片键）</h4><p>在分库分表时，用来决定数据存储到哪个库、哪个表的字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 假设有 4 个库，每库 8 张表</span><br><span class="line">int dbCount = 4;</span><br><span class="line">int tableCount = 8;</span><br><span class="line"></span><br><span class="line">long userId = 123456789L;</span><br><span class="line">int dbIndex = (int)(userId % dbCount);           // 决定库</span><br><span class="line">int tableIndex = (int)(userId / dbCount % tableCount); // 决定表</span><br><span class="line">String tableName = &quot;order_&quot; + dbIndex + &quot;_&quot; + tableIndex;</span><br></pre></td></tr></table></figure>

<h5 id="ShardingSphere"><a href="#ShardingSphere" class="headerlink" title="ShardingSphere"></a>ShardingSphere</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">shardingsphere:</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">      <span class="attr">names:</span> <span class="string">ds0,</span> <span class="string">ds1</span></span><br><span class="line">      <span class="attr">ds0:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line">        <span class="attr">jdbc-url:</span> <span class="string">jdbc:mysql://localhost:3306/db0</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="attr">ds1:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line">        <span class="attr">jdbc-url:</span> <span class="string">jdbc:mysql://localhost:3306/db1</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="attr">sharding:</span></span><br><span class="line">        <span class="attr">tables:</span></span><br><span class="line">          <span class="attr">t_order:</span></span><br><span class="line">            <span class="attr">actual-data-nodes:</span> <span class="string">ds$-&gt;&#123;0..1&#125;.t_order_$-&gt;&#123;0..3&#125;</span></span><br><span class="line">            <span class="attr">table-strategy:</span></span><br><span class="line">              <span class="attr">standard:</span></span><br><span class="line">                <span class="attr">sharding-column:</span> <span class="string">user_id</span> <span class="string">//</span> <span class="string">选择路由id</span></span><br><span class="line">                <span class="attr">sharding-algorithm-name:</span> <span class="string">order-inline</span> <span class="string">//</span> <span class="string">选择映射算法</span></span><br><span class="line">        <span class="attr">sharding-algorithms:</span></span><br><span class="line">            <span class="attr">order-inline:</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">INLINE</span></span><br><span class="line">                <span class="attr">props:</span></span><br><span class="line">                <span class="attr">algorithm-expression:</span> <span class="string">t_order_$-&gt;&#123;user_id</span> <span class="string">%</span> <span class="number">4</span><span class="string">&#125;</span> <span class="string">//</span> <span class="string">表映射算法实际执行</span></span><br><span class="line">            <span class="attr">db-inline:</span></span><br><span class="line">                <span class="attr">type:</span> <span class="string">INLINE</span></span><br><span class="line">                <span class="attr">props:</span></span><br><span class="line">                <span class="attr">algorithm-expression:</span> <span class="string">ds$-&gt;&#123;user_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span> <span class="string">//</span> <span class="string">库映射算法</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="定时任务-x2F-定间隔任务"><a href="#定时任务-x2F-定间隔任务" class="headerlink" title="定时任务&#x2F;定间隔任务"></a>定时任务&#x2F;定间隔任务</h3><p>使用Quartz进行定时任务的持久化，防止任务丢失</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 任务的执行逻辑</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MonitoringJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MonitoringRepository monitoringRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AlertService alertService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ExternalDataService externalDataService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        JobDataMap dataMap = context.getMergedJobDataMap();</span><br><span class="line">        String controlId = dataMap.getString(<span class="string">&quot;controlId&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取最新 Monitoring 配置</span></span><br><span class="line">        Monitoring monitoring = monitoringRepository.findByControlId(controlId);</span><br><span class="line">        <span class="keyword">if</span> (monitoring == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> alertFlag = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">switch</span> (monitoring.getDataSourceType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> API:</span><br><span class="line">                <span class="keyword">double</span> value = externalDataService.getMetric(monitoring.getDataSourceApi(), monitoring.getMetricName());</span><br><span class="line">                alertFlag = value &gt; monitoring.getThreshold();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FILE:</span><br><span class="line">                <span class="keyword">double</span> fileValue = externalDataService.parseReport(monitoring.getReportPath(), monitoring.getMetricName());</span><br><span class="line">                alertFlag = fileValue &gt; monitoring.getThreshold();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SELF_ASSESSMENT:</span><br><span class="line">                <span class="keyword">double</span> userValue = monitoring.getLastSelfAssessmentValue();</span><br><span class="line">                alertFlag = userValue &gt; monitoring.getThreshold();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        monitoring.setLastRun(LocalDateTime.now());</span><br><span class="line">        monitoring.setAlertFlag(alertFlag);</span><br><span class="line">        monitoringRepository.save(monitoring);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (alertFlag) alertService.sendAlert(monitoring);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Monitoring executed for Control: &quot;</span> + controlId + <span class="string">&quot;, alert: &quot;</span> + alertFlag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Quartz任务管理</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzMonitoringService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Scheduler scheduler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建或更新任务</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createMonitoringTask</span><span class="params">(Control control)</span> <span class="keyword">throws</span> SchedulerException </span>&#123;</span><br><span class="line">        JobKey jobKey = JobKey.jobKey(<span class="string">&quot;MonitoringJob_&quot;</span> + control.getId());</span><br><span class="line">        TriggerKey triggerKey = TriggerKey.triggerKey(<span class="string">&quot;MonitoringTrigger_&quot;</span> + control.getId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除旧任务</span></span><br><span class="line">        <span class="keyword">if</span> (scheduler.checkExists(jobKey)) &#123;</span><br><span class="line">            scheduler.deleteJob(jobKey);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        JobDetail jobDetail = JobBuilder.newJob(MonitoringJob.class)</span><br><span class="line">                .withIdentity(jobKey)</span><br><span class="line">                .usingJobData(<span class="string">&quot;controlId&quot;</span>, control.getId())</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        CronTrigger trigger = TriggerBuilder.newTrigger()</span><br><span class="line">                .withIdentity(triggerKey)</span><br><span class="line">                .withSchedule(CronScheduleBuilder.cronSchedule(convertFrequencyToCron(control.getMonitoringFrequency())))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        scheduler.scheduleJob(jobDetail, trigger);</span><br><span class="line">        System.out.println(<span class="string">&quot;Scheduled Monitoring Job for Control: &quot;</span> + control.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">convertFrequencyToCron</span><span class="params">(String frequency)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (frequency.toLowerCase()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;monthly&quot;</span>: <span class="keyword">return</span> <span class="string">&quot;0 0 2 1 * ?&quot;</span>; <span class="comment">// 每月 1 号凌晨2点</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;weekly&quot;</span>: <span class="keyword">return</span> <span class="string">&quot;0 0 2 ? * MON&quot;</span>; <span class="comment">// 每周一凌晨2点</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;daily&quot;</span>:</span><br><span class="line">            <span class="keyword">default</span>: <span class="keyword">return</span> <span class="string">&quot;0 0 2 * * ?&quot;</span>; <span class="comment">// 每天凌晨2点</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除任务</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteMonitoringTask</span><span class="params">(String controlId)</span> <span class="keyword">throws</span> SchedulerException </span>&#123;</span><br><span class="line">        JobKey jobKey = JobKey.jobKey(<span class="string">&quot;MonitoringJob_&quot;</span> + controlId);</span><br><span class="line">        <span class="keyword">if</span> (scheduler.checkExists(jobKey)) &#123;</span><br><span class="line">            scheduler.deleteJob(jobKey);</span><br><span class="line">            System.out.println(<span class="string">&quot;Deleted Monitoring Job for Control: &quot;</span> + controlId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="JBPM"><a href="#JBPM" class="headerlink" title="JBPM"></a>JBPM</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个Process</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControlWorkflowService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RuntimeManager runtimeManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TaskService taskService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">startControlProcess</span><span class="params">(ControlDto controlDto)</span> </span>&#123;</span><br><span class="line">        RuntimeEngine engine = runtimeManager.getRuntimeEngine(<span class="keyword">null</span>);</span><br><span class="line">        RuntimeEngine sessionEngine = engine;</span><br><span class="line">        KieSession ksession = sessionEngine.getKieSession();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 流程参数</span></span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">&quot;controlId&quot;</span>, controlDto.getId());</span><br><span class="line">        params.put(<span class="string">&quot;creator&quot;</span>, controlDto.getCreator());</span><br><span class="line">        params.put(<span class="string">&quot;monitoringApprover&quot;</span>, controlDto.getMonitoringApprover());</span><br><span class="line">        params.put(<span class="string">&quot;testingApprover&quot;</span>, controlDto.getTestingApprover());</span><br><span class="line">        params.put(<span class="string">&quot;ibrcApprover&quot;</span>, controlDto.getIbrcApprover());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建流程实例</span></span><br><span class="line">        WorkflowProcessInstance processInstance = (WorkflowProcessInstance)</span><br><span class="line">                ksession.startProcess(<span class="string">&quot;ControlCreationProcess&quot;</span>, params);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 手动创建 Monitoring &amp; Testing 任务</span></span><br><span class="line">        createUserTask(<span class="string">&quot;MonitoringCreation&quot;</span>, <span class="string">&quot;MonitoringCreationTask&quot;</span>, controlDto.getMonitoringApprover(), processInstance.getId());</span><br><span class="line">        createUserTask(<span class="string">&quot;TestingCreation&quot;</span>, <span class="string">&quot;TestingCreationTask&quot;</span>, controlDto.getTestingApprover(), processInstance.getId());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> processInstance.getId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createUserTask</span><span class="params">(String name, String taskName, String assignee, <span class="keyword">long</span> processInstanceId)</span> </span>&#123;</span><br><span class="line">        Task task = taskService.newTask();</span><br><span class="line">        task.setName(taskName);</span><br><span class="line">        task.setPriority(<span class="number">1</span>);</span><br><span class="line">        task.setProcessInstanceId(processInstanceId);</span><br><span class="line">        task.setTaskData(<span class="keyword">new</span> TaskData());</span><br><span class="line">        task.setPeopleAssignments(<span class="keyword">new</span> PeopleAssignments());</span><br><span class="line">        task.getPeopleAssignments().setPotentialOwners(Collections.singletonList(<span class="keyword">new</span> User(assignee)));</span><br><span class="line"></span><br><span class="line">        taskService.addTask(task, <span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line">        System.out.println(name + <span class="string">&quot; Task created for &quot;</span> + assignee);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 完成任务</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkflowTaskService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TaskService taskService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completeTask</span><span class="params">(Long taskId, String userId, Map&lt;String, Object&gt; results)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 必须由指定 approver 完成</span></span><br><span class="line">        Task task = taskService.getTaskById(taskId);</span><br><span class="line">        <span class="keyword">if</span> (!task.getPeopleAssignments().getPotentialOwners().stream()</span><br><span class="line">                .anyMatch(u -&gt; u.getId().equals(userId))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;User &quot;</span> + userId + <span class="string">&quot; is not the approver for this task&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 领取任务</span></span><br><span class="line">        taskService.claim(taskId, userId);</span><br><span class="line">        taskService.start(taskId, userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 完成任务</span></span><br><span class="line">        taskService.complete(taskId, userId, results);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Task &quot;</span> + taskId + <span class="string">&quot; completed by &quot;</span> + userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果两个并行任务完成，则生成 IBRC Review</span></span><br><span class="line">        checkAndCreateIBRCReview(task.getProcessInstanceId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkAndCreateIBRCReview</span><span class="params">(<span class="keyword">long</span> processInstanceId)</span> </span>&#123;</span><br><span class="line">        List&lt;Task&gt; tasks = taskService.createTaskQuery()</span><br><span class="line">                .processInstanceId(processInstanceId)</span><br><span class="line">                .list();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> monitoringDone = tasks.stream().noneMatch(t -&gt; t.getName().equals(<span class="string">&quot;MonitoringCreationTask&quot;</span>));</span><br><span class="line">        <span class="keyword">boolean</span> testingDone = tasks.stream().noneMatch(t -&gt; t.getName().equals(<span class="string">&quot;TestingCreationTask&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (monitoringDone &amp;&amp; testingDone) &#123;</span><br><span class="line">            <span class="comment">// 创建 IBRC Review Task</span></span><br><span class="line">            Task ibrcTask = taskService.newTask();</span><br><span class="line">            ibrcTask.setName(<span class="string">&quot;IBRCReviewTask&quot;</span>);</span><br><span class="line">            ibrcTask.setProcessInstanceId(processInstanceId);</span><br><span class="line">            ibrcTask.setPriority(<span class="number">1</span>);</span><br><span class="line">            ibrcTask.setPeopleAssignments(<span class="keyword">new</span> PeopleAssignments());</span><br><span class="line">            <span class="comment">// 这里假设 ibrcApprover 存在于流程参数中</span></span><br><span class="line">            String ibrcApprover = <span class="string">&quot;ibrc_user&quot;</span>; <span class="comment">// 可从流程实例参数读取</span></span><br><span class="line">            ibrcTask.getPeopleAssignments().setPotentialOwners(Collections.singletonList(<span class="keyword">new</span> User(ibrcApprover)));</span><br><span class="line"></span><br><span class="line">            taskService.addTask(ibrcTask, <span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line">            System.out.println(<span class="string">&quot;IBRC Review Task created for &quot;</span> + ibrcApprover);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="AI应用"><a href="#AI应用" class="headerlink" title="AI应用"></a>AI应用</h3><ul>
<li><p>用LlamaParser来解决pdf提取成RAG的问题</p>
</li>
<li><p>MCP的开发，使用SPringAI可以开发两种模式的MCP</p>
</li>
</ul>
<ol>
<li>stdio: @Tool指定工具description@TooParameter指定工具参数的description，然后以把工具类注册到<code>ToolCallBackProvider</code>中jar包的形式进行读取，并且要把spring main方法的wei应用设置为false</li>
<li>sse mcp：基本代码与stdio一致，只是调用的时候需要用http或者sse的方式调用</li>
</ol>
<ul>
<li>RAG优化</li>
</ul>
<ol>
<li>文档分割，Llamaparser + Embedding模型 + 递归分割 + 正则 防止分割掉表</li>
<li>Rerank打分，作为大模型引用的权重</li>
</ol>
<ul>
<li><p>Prompt优化</p>
</li>
<li><p>限定角色和回答空间</p>
</li>
<li><p>限定从Rag中获取回答</p>
</li>
<li><p>补强多模态！！！！！！</p>
</li>
<li><p>应用部署的时候有哪些要点</p>
</li>
</ul>
<p>实时性的算法，放在本地<br>生成式的算法，放在云端</p>
<h3 id="大模型"><a href="#大模型" class="headerlink" title="大模型"></a>大模型</h3><h4 id="大模型微调"><a href="#大模型微调" class="headerlink" title="大模型微调"></a>大模型微调</h4><p>假设任务是 文本分类（情感分析为例）：</p>
<ol>
<li>选择预训练模型</li>
</ol>
<ul>
<li>比如 Hugging Face 的 bert-base-uncased 或者 llama-7b</li>
</ul>
<ol start="2">
<li>准备数据</li>
</ol>
<ul>
<li><p>下游数据集（IMDB、SST-2）</p>
</li>
<li><p>格式化成 (input, label)</p>
</li>
</ul>
<ol start="3">
<li>选择微调方式</li>
</ol>
<ul>
<li><p>如果数据足够 + 显存充裕 → 全参数微调</p>
</li>
<li><p>如果资源有限 → LoRA &#x2F; Adapter &#x2F; Prefix Tuning</p>
</li>
</ul>
<ol start="4">
<li>设置训练策略</li>
</ol>
<ul>
<li><p>优化器：AdamW</p>
</li>
<li><p>学习率：小（1e-5 ~ 5e-5）</p>
</li>
<li><p>Scheduler：Warmup + Cosine Decay</p>
</li>
<li><p>Batch size：显存允许下尽量大</p>
</li>
</ul>
<ol start="5">
<li>训练 &amp; 验证</li>
</ol>
<ul>
<li><p>Monitor validation loss &#x2F; F1 score</p>
</li>
<li><p>Early stopping</p>
</li>
</ul>
<ol start="6">
<li>保存与部署</li>
</ol>
<ul>
<li><p>如果用 LoRA，只保存增量参数（几 MB）</p>
</li>
<li><p>部署时加载基础模型 + LoRA 参数合并</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">from transformers import AutoModelForSequenceClassification, AutoTokenizer, Trainer, TrainingArguments</span><br><span class="line">from peft import LoraConfig, get_peft_model</span><br><span class="line"></span><br><span class="line"># 1. 加载预训练模型</span><br><span class="line">model = AutoModelForSequenceClassification.from_pretrained(&quot;bert-base-uncased&quot;, num_labels=2)</span><br><span class="line"></span><br><span class="line"># 2. 配置 LoRA</span><br><span class="line">lora_config = LoraConfig(</span><br><span class="line">    r=8,                       # 低秩维度</span><br><span class="line">    lora_alpha=32,             # 缩放因子</span><br><span class="line">    target_modules=[&quot;query&quot;, &quot;value&quot;],  # 对 Attention 里的 Wq, Wv 应用 LoRA</span><br><span class="line">    lora_dropout=0.1,</span><br><span class="line">    bias=&quot;none&quot;,</span><br><span class="line">    task_type=&quot;SEQ_CLS&quot;        # 下游任务类型：序列分类</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># 3. 包装模型</span><br><span class="line">model = get_peft_model(model, lora_config)</span><br><span class="line"></span><br><span class="line"># 4. 检查可训练参数</span><br><span class="line">model.print_trainable_parameters()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Langchain4j-构建-Agent"><a href="#Langchain4j-构建-Agent" class="headerlink" title="Langchain4j 构建 Agent"></a>Langchain4j 构建 Agent</h3><h4 id="Sequence-工作流"><a href="#Sequence-工作流" class="headerlink" title="Sequence 工作流"></a>Sequence 工作流</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义agent</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CreativeWriter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UserMessage(&quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">            You are a creative writer.</span></span><br><span class="line"><span class="meta">            Generate a draft of a story no more than</span></span><br><span class="line"><span class="meta">            3 sentences long around the given topic.</span></span><br><span class="line"><span class="meta">            Return only the story and nothing else.</span></span><br><span class="line"><span class="meta">            The topic is &#123;&#123;topic&#125;&#125;.</span></span><br><span class="line"><span class="meta">            &quot;&quot;&quot;)</span></span><br><span class="line">    <span class="meta">@Agent(&quot;Generates a story based on the given topic&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">generateStory</span><span class="params">(<span class="meta">@V(&quot;topic&quot;)</span> String topic)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AudienceEditor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UserMessage(&quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">        You are a professional editor.</span></span><br><span class="line"><span class="meta">        Analyze and rewrite the following story to better align</span></span><br><span class="line"><span class="meta">        with the target audience of &#123;&#123;audience&#125;&#125;.</span></span><br><span class="line"><span class="meta">        Return only the story and nothing else.</span></span><br><span class="line"><span class="meta">        The story is &quot;&#123;&#123;story&#125;&#125;&quot;.</span></span><br><span class="line"><span class="meta">        &quot;&quot;&quot;)</span></span><br><span class="line">    <span class="meta">@Agent(&quot;Edits a story to better fit a given audience&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">editStory</span><span class="params">(<span class="meta">@V(&quot;story&quot;)</span> String story, <span class="meta">@V(&quot;audience&quot;)</span> String audience)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StyleEditor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UserMessage(&quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">        You are a professional editor.</span></span><br><span class="line"><span class="meta">        Analyze and rewrite the following story to better fit and be more coherent with the &#123;&#123;style&#125;&#125; style.</span></span><br><span class="line"><span class="meta">        Return only the story and nothing else.</span></span><br><span class="line"><span class="meta">        The story is &quot;&#123;&#123;story&#125;&#125;&quot;.</span></span><br><span class="line"><span class="meta">        &quot;&quot;&quot;)</span></span><br><span class="line">    <span class="meta">@Agent(&quot;Edits a story to better fit a given style&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">editStory</span><span class="params">(<span class="meta">@V(&quot;story&quot;)</span> String story, <span class="meta">@V(&quot;style&quot;)</span> String style)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NovelCreator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Agent</span></span><br><span class="line">    <span class="function">String <span class="title">createNovel</span><span class="params">(<span class="meta">@V(&quot;topic&quot;)</span> String topic, <span class="meta">@V(&quot;audience&quot;)</span> String audience, <span class="meta">@V(&quot;style&quot;)</span> String style)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例化agent</span></span><br><span class="line">CreativeWriter creativeWriter = AgenticServices</span><br><span class="line">        .agentBuilder(CreativeWriter.class)</span><br><span class="line">        .chatModel(BASE_MODEL)</span><br><span class="line">        .outputName(<span class="string">&quot;story&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">AudienceEditor audienceEditor = AgenticServices</span><br><span class="line">        .agentBuilder(AudienceEditor.class)</span><br><span class="line">        .chatModel(BASE_MODEL)</span><br><span class="line">        .outputName(<span class="string">&quot;story&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">StyleEditor styleEditor = AgenticServices</span><br><span class="line">        .agentBuilder(StyleEditor.class)</span><br><span class="line">        .chatModel(BASE_MODEL)</span><br><span class="line">        .outputName(<span class="string">&quot;story&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">NovelCreator novelCreator = AgenticServices</span><br><span class="line">        .sequenceBuilder(NovelCreator.class)</span><br><span class="line">        .subAgents(creativeWriter, audienceEditor, styleEditor)</span><br><span class="line">        .outputName(<span class="string">&quot;story&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">String story = novelCreator.createNovel(<span class="string">&quot;dragons and wizards&quot;</span>, <span class="string">&quot;young adults&quot;</span>, <span class="string">&quot;fantasy&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Loop-工作流"><a href="#Loop-工作流" class="headerlink" title="Loop 工作流"></a>Loop 工作流</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个loop条件的agent</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StyleScorer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UserMessage(&quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">            You are a critical reviewer.</span></span><br><span class="line"><span class="meta">            Give a review score between 0.0 and 1.0 for the following</span></span><br><span class="line"><span class="meta">            story based on how well it aligns with the style &#x27;&#123;&#123;style&#125;&#125;&#x27;.</span></span><br><span class="line"><span class="meta">            Return only the score and nothing else.</span></span><br><span class="line"><span class="meta">            </span></span><br><span class="line"><span class="meta">            The story is: &quot;&#123;&#123;story&#125;&#125;&quot;</span></span><br><span class="line"><span class="meta">            &quot;&quot;&quot;)</span></span><br><span class="line">    <span class="meta">@Agent(&quot;Scores a story based on how well it aligns with a given style&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">scoreStyle</span><span class="params">(<span class="meta">@V(&quot;story&quot;)</span> String story, <span class="meta">@V(&quot;style&quot;)</span> String style)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">StyleEditor styleEditor = AgenticServices</span><br><span class="line">        .agentBuilder(StyleEditor.class)</span><br><span class="line">        .chatModel(BASE_MODEL)</span><br><span class="line">        .outputName(<span class="string">&quot;story&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">StyleScorer styleScorer = AgenticServices</span><br><span class="line">        .agentBuilder(StyleScorer.class)</span><br><span class="line">        .chatModel(BASE_MODEL)</span><br><span class="line">        .outputName(<span class="string">&quot;score&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">UntypedAgent styleReviewLoop = AgenticServices</span><br><span class="line">        .loopBuilder()</span><br><span class="line">        .subAgents(styleScorer, styleEditor)</span><br><span class="line">        .maxIterations(<span class="number">5</span>)</span><br><span class="line">        .exitCondition( agenticScope -&gt; agenticScope.readState(<span class="string">&quot;score&quot;</span>, <span class="number">0.0</span>) &gt;= <span class="number">0.8</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StyledWriter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Agent</span></span><br><span class="line">    <span class="function">String <span class="title">writeStoryWithStyle</span><span class="params">(<span class="meta">@V(&quot;topic&quot;)</span> String topic, <span class="meta">@V(&quot;style&quot;)</span> String style)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CreativeWriter creativeWriter = AgenticServices</span><br><span class="line">        .agentBuilder(CreativeWriter.class)</span><br><span class="line">        .chatModel(BASE_MODEL)</span><br><span class="line">        .outputName(<span class="string">&quot;story&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">StyledWriter styledWriter = AgenticServices</span><br><span class="line">        .sequenceBuilder(StyledWriter.class)</span><br><span class="line">        .subAgents(creativeWriter, styleReviewLoop)</span><br><span class="line">        .outputName(<span class="string">&quot;story&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">String story = styledWriter.writeStoryWithStyle(<span class="string">&quot;dragons and wizards&quot;</span>, <span class="string">&quot;comedy&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Parallel-工作流"><a href="#Parallel-工作流" class="headerlink" title="Parallel 工作流"></a>Parallel 工作流</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FoodExpert</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UserMessage(&quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">        You are a great evening planner.</span></span><br><span class="line"><span class="meta">        Propose a list of 3 meals matching the given mood.</span></span><br><span class="line"><span class="meta">        The mood is &#123;&#123;mood&#125;&#125;.</span></span><br><span class="line"><span class="meta">        For each meal, just give the name of the meal.</span></span><br><span class="line"><span class="meta">        Provide a list with the 3 items and nothing else.</span></span><br><span class="line"><span class="meta">        &quot;&quot;&quot;)</span></span><br><span class="line">    <span class="meta">@Agent</span></span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">findMeal</span><span class="params">(<span class="meta">@V(&quot;mood&quot;)</span> String mood)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MovieExpert</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UserMessage(&quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">        You are a great evening planner.</span></span><br><span class="line"><span class="meta">        Propose a list of 3 movies matching the given mood.</span></span><br><span class="line"><span class="meta">        The mood is &#123;mood&#125;.</span></span><br><span class="line"><span class="meta">        Provide a list with the 3 items and nothing else.</span></span><br><span class="line"><span class="meta">        &quot;&quot;&quot;)</span></span><br><span class="line">    <span class="meta">@Agent</span></span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">findMovie</span><span class="params">(<span class="meta">@V(&quot;mood&quot;)</span> String mood)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FoodExpert foodExpert = AgenticServices</span><br><span class="line">        .agentBuilder(FoodExpert.class)</span><br><span class="line">        .chatModel(BASE_MODEL)</span><br><span class="line">        .outputName(<span class="string">&quot;meals&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">MovieExpert movieExpert = AgenticServices</span><br><span class="line">        .agentBuilder(MovieExpert.class)</span><br><span class="line">        .chatModel(BASE_MODEL)</span><br><span class="line">        .outputName(<span class="string">&quot;movies&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">EveningPlannerAgent eveningPlannerAgent = AgenticServices</span><br><span class="line">        .parallelBuilder(EveningPlannerAgent.class)</span><br><span class="line">        .subAgents(foodExpert, movieExpert)</span><br><span class="line">        .executor(Executors.newFixedThreadPool(<span class="number">2</span>))</span><br><span class="line">        .outputName(<span class="string">&quot;plans&quot;</span>)</span><br><span class="line">        .output(agenticScope -&gt; &#123;</span><br><span class="line">            List&lt;String&gt; movies = agenticScope.readState(<span class="string">&quot;movies&quot;</span>, List.of());</span><br><span class="line">            List&lt;String&gt; meals = agenticScope.readState(<span class="string">&quot;meals&quot;</span>, List.of());</span><br><span class="line"></span><br><span class="line">            List&lt;EveningPlan&gt; moviesAndMeals = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; movies.size(); i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i &gt;= meals.size()) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                moviesAndMeals.add(<span class="keyword">new</span> EveningPlan(movies.get(i), meals.get(i)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> moviesAndMeals;</span><br><span class="line">        &#125;)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">List&lt;EveningPlan&gt; plans = eveningPlannerAgent.plan(<span class="string">&quot;romantic&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="条件工作流"><a href="#条件工作流" class="headerlink" title="条件工作流"></a>条件工作流</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CategoryRouter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UserMessage(&quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">        Analyze the following user request and categorize it as &#x27;legal&#x27;, &#x27;medical&#x27; or &#x27;technical&#x27;.</span></span><br><span class="line"><span class="meta">        In case the request doesn&#x27;t belong to any of those categories categorize it as &#x27;unknown&#x27;.</span></span><br><span class="line"><span class="meta">        Reply with only one of those words and nothing else.</span></span><br><span class="line"><span class="meta">        The user request is: &#x27;&#123;&#123;request&#125;&#125;&#x27;.</span></span><br><span class="line"><span class="meta">        &quot;&quot;&quot;)</span></span><br><span class="line">    <span class="meta">@Agent(&quot;Categorizes a user request&quot;)</span></span><br><span class="line">    <span class="function">RequestCategory <span class="title">classify</span><span class="params">(<span class="meta">@V(&quot;request&quot;)</span> String request)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">RequestCategory</span> </span>&#123;</span><br><span class="line">    LEGAL, MEDICAL, TECHNICAL, UNKNOWN</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MedicalExpert</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@UserMessage(&quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">        You are a medical expert.</span></span><br><span class="line"><span class="meta">        Analyze the following user request under a medical point of view and provide the best possible answer.</span></span><br><span class="line"><span class="meta">        The user request is &#123;&#123;request&#125;&#125;.</span></span><br><span class="line"><span class="meta">        &quot;&quot;&quot;)</span></span><br><span class="line">    <span class="meta">@Agent(&quot;A medical expert&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">medical</span><span class="params">(<span class="meta">@V(&quot;request&quot;)</span> String request)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExpertRouterAgent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Agent</span></span><br><span class="line">    <span class="function">String <span class="title">ask</span><span class="params">(<span class="meta">@V(&quot;request&quot;)</span> String request)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CategoryRouter routerAgent = AgenticServices</span><br><span class="line">        .agentBuilder(CategoryRouter.class)</span><br><span class="line">        .chatModel(BASE_MODEL)</span><br><span class="line">        .outputName(<span class="string">&quot;category&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">MedicalExpert medicalExpert = AgenticServices</span><br><span class="line">        .agentBuilder(MedicalExpert.class)</span><br><span class="line">        .chatModel(BASE_MODEL)</span><br><span class="line">        .outputName(<span class="string">&quot;response&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line">LegalExpert legalExpert = AgenticServices</span><br><span class="line">        .agentBuilder(LegalExpert.class)</span><br><span class="line">        .chatModel(BASE_MODEL)</span><br><span class="line">        .outputName(<span class="string">&quot;response&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line">TechnicalExpert technicalExpert = AgenticServices</span><br><span class="line">        .agentBuilder(TechnicalExpert.class)</span><br><span class="line">        .chatModel(BASE_MODEL)</span><br><span class="line">        .outputName(<span class="string">&quot;response&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">UntypedAgent expertsAgent = AgenticServices.conditionalBuilder()</span><br><span class="line">        .subAgents( agenticScope -&gt; agenticScope.readState(<span class="string">&quot;category&quot;</span>, RequestCategory.UNKNOWN) == RequestCategory.MEDICAL, medicalExpert)</span><br><span class="line">        .subAgents( agenticScope -&gt; agenticScope.readState(<span class="string">&quot;category&quot;</span>, RequestCategory.UNKNOWN) == RequestCategory.LEGAL, legalExpert)</span><br><span class="line">        .subAgents( agenticScope -&gt; agenticScope.readState(<span class="string">&quot;category&quot;</span>, RequestCategory.UNKNOWN) == RequestCategory.TECHNICAL, technicalExpert)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">ExpertRouterAgent expertRouterAgent = AgenticServices</span><br><span class="line">        .sequenceBuilder(ExpertRouterAgent.class)</span><br><span class="line">        .subAgents(routerAgent, expertsAgent)</span><br><span class="line">        .outputName(<span class="string">&quot;response&quot;</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">String response = expertRouterAgent.ask(<span class="string">&quot;I broke my leg what should I do&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="项目上线后还有做RAG的评估吗？"><a href="#项目上线后还有做RAG的评估吗？" class="headerlink" title="项目上线后还有做RAG的评估吗？"></a>项目上线后还有做RAG的评估吗？</h4><p>“我们在 RAG 应用上线后，做了分层次的评估。检索层主要用标注集+ nDCG 来看召回和相关性；生成层我们抽样做人工和 GPT-as-a-judge 评审，监控正确性和幻觉率；系统层面重点监控延迟和索引更新的及时性；最后还接入了埋点和用户反馈，用 A&#x2F;B 测试来持续优化。这套机制可以保证 RAG 效果不会随着时间或数据更新而劣化。”</p>
<h4 id="MCP内容是什么"><a href="#MCP内容是什么" class="headerlink" title="MCP内容是什么"></a>MCP内容是什么</h4><p><img src="https://i.imgur.com/zSNzkh4.png" alt="picture 1">  </p>
<p>快                                   |</p>
<h3 id="Java锁机制"><a href="#Java锁机制" class="headerlink" title="Java锁机制"></a>Java锁机制</h3><h4 id="排他锁"><a href="#排他锁" class="headerlink" title="排他锁"></a>排他锁</h4><ul>
<li>synchronized</li>
<li>ReentrantLock</li>
</ul>
<h4 id="共享锁"><a href="#共享锁" class="headerlink" title="共享锁"></a>共享锁</h4><ul>
<li>ReentrantReadWriteLock</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ReentrantReadWriteLock rwLock = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">Lock readLock = rwLock.readLock();</span><br><span class="line">Lock writeLock = rwLock.writeLock();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读操作</span></span><br><span class="line">readLock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123; ... &#125; <span class="keyword">finally</span> &#123; readLock.unlock(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写操作</span></span><br><span class="line">writeLock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123; ... &#125; <span class="keyword">finally</span> &#123; writeLock.unlock(); &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>semaphore</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 允许多个线程同时访问</span></span><br><span class="line">Semaphore sem = <span class="keyword">new</span> Semaphore(<span class="number">5</span>); <span class="comment">// 最多 5 个线程同时访问</span></span><br><span class="line">sem.acquire();</span><br><span class="line"><span class="keyword">try</span> &#123; ... &#125; <span class="keyword">finally</span> &#123; sem.release(); &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>StampedLock</li>
</ul>
<p>提供 乐观读锁（optimistic read） 和 写锁</p>
<p>乐观读锁是一种轻量共享锁，读操作无需阻塞写线程，只在冲突时回退</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">StampedLock sl = <span class="keyword">new</span> StampedLock();</span><br><span class="line"><span class="keyword">long</span> stamp = sl.readLock(); <span class="comment">// 共享锁</span></span><br><span class="line"><span class="keyword">try</span> &#123; ... &#125; <span class="keyword">finally</span> &#123; sl.unlockRead(stamp); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> wstamp = sl.writeLock(); <span class="comment">// 排他锁</span></span><br><span class="line"><span class="keyword">try</span> &#123; ... &#125; <span class="keyword">finally</span> &#123; sl.unlockWrite(wstamp); &#125;</span><br></pre></td></tr></table></figure>

<h4 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h4><ul>
<li>Atomic包下的所有，都是用的CAS</li>
<li>StampedLock 获取锁的时候先获取版本戳</li>
</ul>
<p>读的时候先获取一个版本戳（stamp），</p>
<p>写操作时 stamp 会失效，读操作检查 stamp 是否变化，若变化则说明有并发写，需要回退。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">StampedLock lock = <span class="keyword">new</span> StampedLock();</span><br><span class="line"><span class="keyword">long</span> stamp = lock.tryOptimisticRead();</span><br><span class="line"><span class="keyword">int</span> value = sharedData; <span class="comment">// 假设是共享变量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 校验是否有写操作</span></span><br><span class="line"><span class="keyword">if</span> (!lock.validate(stamp)) &#123;</span><br><span class="line">    stamp = lock.readLock(); </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        value = sharedData;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlockRead(stamp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AQS-AbstractQueuedSynchronizer"><a href="#AQS-AbstractQueuedSynchronizer" class="headerlink" title="AQS( AbstractQueuedSynchronizer)"></a>AQS( AbstractQueuedSynchronizer)</h4><ol>
<li>Sync extends AQS</li>
</ol>
<ul>
<li>我们继承 AQS，实现 tryAcquire 和 tryRelease</li>
<li>AQS 通过 state 管理锁状态</li>
<li>AQS 通过 FIFO 队列 管理等待线程</li>
</ul>
<ol start="2">
<li>lock() 调用 sync.acquire(1)</li>
</ol>
<ul>
<li>AQS 的模板方法 acquire 会：</li>
<li>尝试调用 tryAcquire</li>
<li>如果失败 → 把线程放入队列 → 阻塞（park）</li>
<li>等待唤醒 → 再次尝试获取锁</li>
</ul>
<ol start="3">
<li>unlock() 调用 sync.release(1)</li>
</ol>
<ul>
<li>AQS 模板方法 release 会：</li>
<li>调用 tryRelease 修改 state</li>
<li>成功 → 唤醒队列头节点线程</li>
</ul>
<ol start="4">
<li>线程排队</li>
</ol>
<ul>
<li>当多个线程同时抢锁时，失败的线程会进入 CLH 队列 等待</li>
<li>队列保证公平（FIFO）或根据具体实现策略抢锁</li>
</ul>
<h4 id="JVM锁的原理-当JVM锁释放了，其余线程如何知道，如何竞争"><a href="#JVM锁的原理-当JVM锁释放了，其余线程如何知道，如何竞争" class="headerlink" title="JVM锁的原理,当JVM锁释放了，其余线程如何知道，如何竞争"></a>JVM锁的原理,当JVM锁释放了，其余线程如何知道，如何竞争</h4><p>JVM 锁的本质</p>
<ul>
<li>Java 中的 synchronized 是一种 对象监视器锁（Monitor）</li>
<li>JVM 层实现：每个对象都对应一个 对象头（Mark Word）</li>
<li>锁信息存储在对象头中，同时有一个 Monitor（互斥量） 管理线程阻塞和唤醒</li>
</ul>
<p>锁释放后其他线程如何知道</p>
<ul>
<li>当前线程执行 synchronized 代码块结束 → JVM 调用 exit monitor</li>
<li>对象头状态恢复（释放锁）</li>
<li>Monitor 检查等待队列：</li>
<li>如果有等待线程 → 唤醒队列头线程</li>
<li>唤醒线程会重新尝试获取锁（CAS 或内部状态判断）</li>
<li>竞争成功 → 获得锁</li>
<li>竞争失败 → 继续排队等待</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/13/%E5%AE%9E%E9%99%85%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98/" rel="prev" title="实际面试问题">
                  <i class="fa fa-chevron-left"></i> 实际面试问题
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Weirdo</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"weirdoblog","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
